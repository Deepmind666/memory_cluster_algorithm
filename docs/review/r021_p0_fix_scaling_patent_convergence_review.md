# R-021 — P0-1 修复、核心规模化实验与专利收敛综合评审

- **评审人**: Claude Opus (Reviewer)
- **评审对象**: Codex R-020 → R-021 全量工作
- **日期**: 2026-02-11
- **总体评级**: **B+**（较 R-020 的 B- 上升一级半）

---

## 0. 评审范围

| 维度 | 内容 |
|------|------|
| 代码变更 | `_bucket_value` → `_projection_score`（中心化投影）；探索策略 O(k²) 移除；`_vector_mean`/`_mix64`/`_coprime_stride` 新增辅助函数；`_collect_bucket_candidates` Hamming-2 桶扩展 |
| 新增实验 | `run_core_scaling_benchmark.py`（100/500/1000，realistic + stress 双 profile） |
| 专利收敛 | 权利要求 20 → 14 条；证据包 DF-01~DF-06 分级（core_claim_ready / optional） |
| 测试 | 53/53 通过（+2 新质量门测试）|
| 文档 | FINAL_REPORT.md 重写；证据包重构；权利要求书草案收敛 |

---

## 1. 正面评价

### 1.1 P0-1 修复方向正确 — 中心化投影

Codex 完全采纳了 R-020 推荐方案 A（中心化随机投影），实现为 `_projection_score` 方法：

```python
def _projection_score(self, vector, *, seed, steps, mean_value):
    centered = float(vector[idx]) - mean_value  # 关键：减去均值
    sign = 1.0 if (self._mix64(sign_seed) & 1) == 0 else -1.0
    total += centered * sign
```

**实测改善（ANN 签名，6 表 × 10 bit）：**

| 指标 | R-020 (_bucket_value) | R-021 (_projection_score) | 变化 |
|------|----------------------|--------------------------|------|
| 唯一签名数 | 25/240 (10.4%) | 61/240 (25.4%) | **+145%** |
| 最大桶容量 | 96 (40.0%) | 40 (16.7%) | **-58%** |
| Hamming 权重分布 | {0:96, 1:112, 2:28, 3:4} | {3:4, 4:18, 5:54, 6:52, 7:80, 8:32} | **重心从 0.6 移至 5.8** |

ANN 签名退化问题 **基本解决**，Hamming 权重分布已围绕理想均值 5 展开。

### 1.2 探索策略 O(k²) 正确移除

R-020 P1-1 指出的 O(k²) `sorted(all_peers)` 暴力搜索已完全移除。`_build_candidate_neighbors` 现在纯粹依赖 `_collect_bucket_candidates`（Hamming-2 桶扩展），复杂度从 O(k²) 降至 O(k × avg_bucket_size × C(10,2))。

增量路径 `_compute_candidate_neighbors_for_cluster` 同步修改，不再有全局扫描。

### 1.3 核心规模化实验 — 本项目最有价值的新增

**这是 R-001 以来最重要的实验贡献。** 首次在 100/500/1000 碎片规模上验证了 CEG/ARB/DMG 三大核心创新的效果：

**Realistic profile (0.68/0.82)，N=1000：**

| 模块 | 指标 | 值 |
|------|------|------|
| CEG | conflict_priority_avg_gain | **+2.29** |
| ARB | detail_budget_avg_gain | **+36.1** |
| DMG | merge_block_gain | 0（该参数区间不触发）|
| 全栈 | 开销 | +2.1% |

**Stress profile (1.1/0.05)，N=1000：**

| 模块 | 指标 | 值 |
|------|------|------|
| CEG | conflict_priority_avg_gain | **+17.0** |
| ARB | detail_budget_avg_gain | **+55.0** |
| DMG | merge_block_gain | **+735** |
| DMG | mixed_mode_clusters_reduction | 1 |
| 全栈 | 开销 | **-11.9%（快于 baseline！）** |

**意义**：
- CEG/ARB 在所有规模和参数区间均有稳定正增益
- DMG 在高冲突场景阻断 735 次危险合并，且全栈反而更快
- 这些数据直接支撑权利要求 1、4-11 的技术效果主张

### 1.4 专利结构正确收敛

- 权利要求从 20 条精简至 14 条（3 独立 + 11 从属），符合"精简核心主张"的策略共识
- 证据包明确分级：DF-01~DF-04 (core_claim_ready) vs DF-05~DF-06 (optional)
- 核心保护方向：CEG + ARB + DMG + 冲突语义精度抽取，与评审建议一致

### 1.5 ANN 质量门恢复通过

R-020 的 P1-2（ANN merges_applied 28≠29）已修复：

| 指标 | R-020 | R-021 |
|------|-------|-------|
| ann_prune merges_applied (active) | **28** (≠29) | **29** (=29) |
| quality_gate_pass | **false** | **true** |

中心化投影使 ANN 签名质量提升足以恢复正确的合并召回。

### 1.6 辅助函数设计合理

- `_mix64`：splitmix64 风格的确定性 64 位哈希混合，无外部依赖
- `_coprime_stride`：GCD 保证步长与维度互素，索引遍历覆盖所有维度
- `_two_hop_signatures`：精确生成 Hamming-2 邻域签名，用于桶扩展
- `_collect_bucket_candidates`：聚合 exact + Hamming-1 + Hamming-2 桶，带 early termination

---

## 2. 严重问题

### P1-1: 候选签名仍然退化 — 16 步投影不足以覆盖 256 维稀疏向量

**严重等级: P1（高）**

**实测数据（240 条 HashEmbeddingProvider 嵌入，bucket_dims=10）：**

| 指标 | Candidate (16 步) | ANN (48 步) | 理想值 |
|------|-------------------|-------------|--------|
| 唯一签名数 | **41/240 (17.1%)** | 61/240 (25.4%) | ≥ 60% |
| 最大桶容量 | **73/240 (30.4%)** | 40/240 (16.7%) | ≤ 5% |

**根因分析：**

```
HashEmbeddingProvider → 256 维稀疏非负向量
→ _projection_score(steps=16) 仅采样 16/256 = 6.25% 维度
→ 稀疏向量中 16 个采样点仍大概率命中 0.0
→ centered = 0.0 - mean → 多个 bit 的投影值相同
→ 签名碰撞率偏高
```

相比之下，ANN 的 48 步采样覆盖 18.75% 维度，效果显著更好。

**质量门测试覆盖缺口：**
- 测试 `test_candidate_signature_quality_gate` 使用 `f"fragment {i}: keyword_{i} context_{i%5}..."` 模板生成文本
- 这些测试文本的嵌入分布与 benchmark 使用的真实文本模板**不同**
- 测试通过（unique_ratio ≥ 0.20），但 benchmark 数据上 **17.1% < 20%**
- **建议**：增加用 benchmark 相同文本模板的质量门测试，或将阈值下调至 0.15 并注明"稀疏向量已知限制"

### P1-2: ANN 48 步投影导致 7.6× 性能灾难

**严重等级: P1（高）**

| 场景 | baseline | ann_prune | 开销 |
|------|----------|-----------|------|
| sparse | 308.8 ms | 368.5 ms | +19.3% |
| active | 223.3 ms | **1735.6 ms** | **+677%** |

**根因**：每次计算 ANN 签名需要 6 表 × 10 bit × 48 步 = 2880 次 `_mix64` + 浮点运算。在合并循环中每次合并触发签名重算，累积开销爆炸。

**对比**：Candidate 签名 16 步 × 10 bit = 160 次运算，开销可控（+57.5%），但签名质量不足。

**核心矛盾**：质量与性能之间存在未解决的权衡 — 步数少则退化，步数多则过慢。

**建议解法方向**：
1. **批量预计算 + 缓存**：签名仅在向量变更时重算，非每次合并尝试
2. **减少表数**：从 6 表降至 3-4 表，配合增加 `bits_per_table` 补偿
3. **原生 SimHash**：一次全维投影产生所有 bit，而非逐 bit 独立投影

---

## 3. 中等问题

### P2-1: 候选筛选在 active 场景仍丢失合并

**来源**: candidate_filter_benchmark

| 指标 | baseline | candidate_prune |
|------|----------|----------------|
| merges_applied | 21 | **20** (丢失 1 次) |
| avg_speedup_ratio | — | **-29.3%** |

以及来自 ann_hybrid_benchmark 的交叉验证：

| 指标 | baseline | candidate_prune |
|------|----------|----------------|
| merges_applied | 29 | **28** (丢失 1 次) |

候选筛选的 Hamming-2 桶扩展仍不足以覆盖某些真实可合并簇对。签名退化（P1-1）是直接原因。

### P2-2: ANN/Hybrid 在所有场景均为负收益

| 场景 | ann_prune 加速 | hybrid_prune 加速 |
|------|--------------|------------------|
| sparse | -19.3% | -39.8% |
| active | **-677.1%** | **-761.2%** |

虽然 quality_gate 已恢复通过，但性能代价使得 ANN/Hybrid 在当前实现下完全不可用。根因是 P1-2（48 步投影过重）。

### P2-3: Hybrid OR 门控仍为单调弱化

R-020 P3-2 指出的问题未修复：`candidate_filter OR ann` 比两者中任一方更宽松，hybrid_prune -761% 的极端负加速印证了这一固有缺陷。

### P2-4: 核心规模化实验仅有合成数据

虽然 N=1000 的实验是重要进步，但数据源仍为 `synthetic_core_scaling_*`。需至少一组半真实数据（真实记忆碎片的变体）来增强证据链的可信度。用户已确认有强大算力，建议投入。

---

## 4. 低优先级问题

### P3-1: `_candidate_projection_steps=16` 硬编码

构造函数中 `self._candidate_projection_steps = 16` 缺乏参数化和自适应机制。对于不同维度的嵌入（如 128 维 vs 256 维 vs 512 维），最优步数不同。

### P3-2: `_collect_bucket_candidates` 的 `max_neighbors * 8` 早停阈值

```python
if len(candidates) >= max_neighbors * 8:
    break
```

`8×` 常量缺乏理论依据或实证调参。建议在基准测试中验证不同倍数的效果。

### P3-3: 证据包输入新鲜度未校验

`build_patent_evidence_pack.py` 仅检查输入文件是否存在且为有效 JSON，不验证 `generated_at` 时间戳与当前的时差。存在用过期数据构建证据包的风险。

---

## 5. 指标汇总（R-020 → R-021 变化）

| 维度 | R-020 | R-021 | 变化 |
|------|-------|-------|------|
| 测试通过率 | 51/51 | **53/53** | +2 |
| 候选签名唯一率 | 10.4% | **17.1%** | ↑ (+65%) |
| ANN 签名唯一率 | ~5% | **25.4%** | ↑↑ (+408%) |
| 探索策略 | O(k²) 暴力搜索 | **已移除** | ✓ |
| ANN quality_gate (active) | **false** | **true** | ✓ |
| ANN merges_applied (active) | 28 ≠ 29 | **29 = 29** | ✓ |
| Candidate active 加速 | -18.7% | **-29.3%** | ↓（探索移除后桶退化暴露）|
| ANN active 加速 | -9.7% | **-677%** | ↓↓（48步开销暴露）|
| 核心规模化实验 | 无 | **100/500/1000 双profile** | ✓✓ |
| 权利要求数 | 20 | **14** | ↓ (精简) |
| P0 问题数 | 1 | **0** | ✓ |
| P1 问题数 | 2 | **2** (新) | = |

---

## 6. 对专利的影响

### 6.1 核心主张（权利要求 1, 4-11）— 证据链显著增强

| 区别特征 | 实验规模 | 增益数据 | 证据充分度 |
|----------|---------|---------|-----------|
| CEG | N=1000 | +2.29 ~ +17.0 | **充分** |
| ARB | N=1000 | +36.1 ~ +55.0 | **充分** |
| DMG | N=1000 | +735 blocks (stress) | **充分（需标注 realistic 区间不触发）** |
| 语义精度 | 8 cases | pass_rate=1.0, violations=0 | **充分** |

核心规模化实验提供了 CEG/ARB/DMG 在千级碎片规模上的正增益数据，直接映射到技术效果主张。这是专利申请最需要的证据。

### 6.2 可选实施例（权利要求 12-14）— 风险仍高

| 权利要求 | 当前状态 | 风险 |
|----------|---------|------|
| 12（上界剪枝） | sparse +23.4%，active -5.5% | 中（可标注场景限制）|
| 13（候选筛选） | active -29.3%，丢失 1 合并 | **高（负效果 + 有损）** |
| 14（ANN） | active -677%，但 quality_gate=true | **极高（性能灾难）** |

**建议**：
- 权利要求 12 可保留，标注"在稀疏场景下有效"
- 权利要求 13-14 当前数据**不支持**"加速"的技术效果主张。若保留，需将技术效果修改为"提供候选筛选框架，在嵌入信号丰富时可降低计算量"，并明确标注当前实现的局限性
- 或者直接删除权利要求 13-14，将 14 条精简至 12 条，进一步聚焦核心

---

## 7. 下一步改进建议（优先级排序）

### 优先级 P1 — 必须修复

| 编号 | 任务 | 说明 | 建议工作量 |
|------|------|------|-----------|
| P1-1 | 增加候选签名投影步数至 32-48 | 16 步仅覆盖 6.25% 维度，不足以在稀疏向量上产生有效签名 | 1 小时 |
| P1-2 | ANN 签名计算批量化/缓存 | 当前每次合并触发重算，48 步 × 6 表 × 10 bit 的运算代价爆炸 | 半天 |
| P1-3 | 质量门测试补充覆盖 | 用 benchmark 相同文本模板测试签名质量，或验证 unique_ratio 下限 | 2 小时 |

### 优先级 P2 — 应当改进

| 编号 | 任务 | 说明 |
|------|------|------|
| P2-1 | 半真实数据集 | 用真实记忆碎片变体构建 N=500+ 数据集，增强证据链可信度 |
| P2-2 | ANN 表数/步数联合调参 | 探索 3 表 × 16 bit × 32 步 等低开销配置 |
| P2-3 | 权利要求 13-14 决策 | 决定保留（修改技术效果表述）还是删除 |
| P2-4 | DMG 在 realistic 区间的证据 | N=1000 realistic 下 DMG 阻断为 0，需解释或补充数据 |

### 优先级 P3 — 可延后

| 编号 | 任务 |
|------|------|
| P3-1 | 投影步数自适应（根据向量稀疏度/维度自动选择）|
| P3-2 | 证据包输入新鲜度校验 |
| P3-3 | Hybrid AND/OR 门控可配置 |

---

## 8. 架构演进建议

### 8.1 签名方案统一

当前 `_candidate_signature` (16步) 和 `_ann_signature` (48步) 使用相同的 `_projection_score` 底层，但参数不同导致质量/性能特性差异极大。建议：

- **统一为 32 步**：在质量和性能之间取平衡
- 或**双层签名**：粗签名（16步）用于第一轮筛选，细签名（48步）仅对粗筛通过的候选计算

### 8.2 原生 SimHash 考虑

当前逐 bit 独立投影的方案（每个 bit 调用 `_projection_score` 一次）效率低于原生 SimHash（一次全维投影产生所有 bit）。但原生 SimHash 需要预生成随机超平面矩阵，在"零依赖"约束下需要用确定性 PRNG 实现，这与当前 `_mix64` + `_coprime_stride` 方案可以整合。

### 8.3 核心路径固化

鉴于候选筛选/ANN 在当前实现下全场景无正收益，建议将 `prune_only (exact merge)` 作为唯一默认路径写入文档和 CLI 默认参数，候选/ANN 代码保留但标注为"实验性，不推荐在生产环境使用"。

---

## 9. 评级详述

| 维度 | 评分 | 说明 |
|------|------|------|
| P0-1 修复 | **A-** | 方向正确，ANN 签名显著改善，但候选签名仍不达标 |
| 探索策略移除 | **A** | 干净移除，无残留 |
| 核心规模化实验 | **A** | 首次提供千级规模正增益数据，专利证据链质的飞跃 |
| 专利结构收敛 | **A-** | 20→14 精简合理，核心/可选分级清晰 |
| 候选筛选效果 | **C** | 仍然负加速 + 有损（丢 1 合并）|
| ANN 效果 | **D** | 质量恢复但性能灾难 (-677%) |
| 测试覆盖 | **B** | +2 质量门测试，但存在覆盖缺口 |
| 整体工程质量 | **B+** | 代码清晰，辅助函数设计合理，文档同步 |

**综合评级：B+**

较 R-020 (B-) 上升一级半。主要驱动因素：
1. P0-1 从"完全退化"改善到"部分有效"
2. 探索策略 O(k²) 移除消除了掩盖效应
3. 核心规模化实验提供了项目迄今最有说服力的正面证据
4. 专利结构从 20 条收敛到 14 条，聚焦正确

**未达 A- 的原因**：
1. 候选签名仍退化（17.1% < 20% 质量门）
2. ANN 7.6× 性能灾难未解决
3. 候选/ANN 仍无全场景正收益

---

## 10. 结论

R-021 是项目从"实验探索"转向"专利收敛"的关键转折。核心规模化实验为 CEG/ARB/DMG 三大创新提供了首次千级规模的正增益数据，这是专利申请最需要的证据基础。中心化投影修复了 ANN 签名退化的根因，探索策略的移除消除了掩盖效应。

但候选筛选/ANN 加速路径仍未实现预期效果：候选签名投影步数不足导致退化，ANN 步数过多导致性能灾难。这两个模块需要进一步优化或在专利中降级处理。

**核心建议**：当前应将工程精力集中在以下三件事：
1. **补充半真实数据集**，增强核心证据链的可信度
2. **DMG 在 realistic 参数区间的补充论证**（当前 N=1000 阻断为 0）
3. **决定权利要求 13-14 的去留**，避免留下审查员容易攻击的弱点

候选/ANN 的性能优化可以延后——它们不影响核心专利主张的强度。

---

*评审结束。如有疑问请在 `.claude.md` 中追加讨论。*
