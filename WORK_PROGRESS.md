# Work Progress Log

> Purpose: Record every meaningful progress update with timestamp, work details, and review checklist.

## Entry 001
- Timestamp: 2026-02-09 14:38:35 +08:00
- Stage: Repository bootstrap
- Actions:
  - Confirmed target task source file: `gptdeepsearch2_9.md`.
  - Initialized local Git repository in `c:\patent\memory_cluster_algorithm`.
  - Set branch to `main`.
  - Added remote origin: `https://github.com/Deepmind666/memory_cluster_algorithm.git`.
- Files Reviewed:
  - `gptdeepsearch2_9.md`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] Requirement understood from user message.
  - [x] Git baseline prepared.
  - [x] No destructive command used.
  - [x] Progress is timestamped.
  - [ ] Deliverable documents finalized.
  - [ ] Final self-audit completed.

## Entry 002
- Timestamp: 2026-02-09 14:42:03 +08:00
- Stage: Prior-art and research baseline
- Actions:
  - Completed targeted online search on papers and patents related to LLM code performance optimization.
  - Collected primary-source references (arXiv, IJCAI, OpenReview, Google Patents).
  - Confirmed key overlap risks with runtime-feedback and IDE insight patents.
- Files Reviewed:
  - gptdeepsearch2_9.md
- External Sources Reviewed:
  - https://arxiv.org/abs/2412.03578
  - https://www.ijcai.org/proceedings/2025/814
  - https://openreview.net/forum?id=KhwOuB0fs9
  - https://openreview.net/forum?id=R5L1TD1Z58
  - https://openreview.net/forum?id=KxFaKvtBiG
  - https://patents.google.com/patent/US11941378B1/en
  - https://patents.google.com/patent/US20250130778A1/en
  - https://patents.google.com/patent/CN119917107A/en
  - https://patents.google.com/patent/US11941373B2
  - https://patents.google.com/patent/US20250165890A1/en
- Files Changed:
  - WORK_PROGRESS.md
- Review Checklist:
  - [x] Sources are current enough for 2026-02-09 baseline.
  - [x] Sources are mostly primary venues.
  - [x] Patent overlap risks identified preliminarily.
  - [ ] Legal counsel review completed (outside scope).

## Entry 003
- Timestamp: 2026-02-09 14:46:29 +08:00
- Stage: Core documentation build
- Actions:
  - 重写主任务文档
  - 新增交接规范文档
  - 新增评审清单
  - 新增进展追加脚本
- Files Reviewed:
  - `gptdeepsearch2_9.md`
- Files Changed:
  - `gptdeepsearch2_9.md`
  - `README.md`
  - `.claude.md`
  - `docs/REVIEW_CHECKLIST.md`
  - `scripts/append_progress.ps1`
  - `.gitignore`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 主任务文档重构完成
  - [x] 交接规范已落地
  - [x] 进展脚本可执行

## Entry 004
- Timestamp: 2026-02-09 14:47:47 +08:00
- Stage: Script hardening
- Actions:
  - 修复反引号转义问题
  - 增强数组参数解析
- Files Reviewed:
  - `scripts/append_progress.ps1`
  - `WORK_PROGRESS.md`
- Files Changed:
  - `scripts/append_progress.ps1`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 脚本可执行通过
  - [x] 日志条目可追加
  - [x] 逗号分隔参数可解析

## Entry 005
- Timestamp: 2026-02-09 14:48:31 +08:00
- Stage: Progress log normalization
- Actions:
  - 修复 Entry 003 的逗号拼接格式问题
  - 将文件清单与检查项改为逐行列表
- Files Reviewed:
  - `WORK_PROGRESS.md`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 日志结构规范化
  - [x] 可读性提升

## Entry 006
- Timestamp: 2026-02-09 14:49:09 +08:00
- Stage: Workspace hygiene
- Actions:
  - 发现本地自动生成 .claude/settings.local.json
  - 将 .claude/ 加入 .gitignore 防止误提交
- Files Reviewed:
  - `.gitignore`
- Files Changed:
  - `.gitignore`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 本地配置已隔离
  - [x] 远程提交范围可控

## Entry 007
- Timestamp: 2026-02-09 14:49:50 +08:00
- Stage: Final self-audit
- Actions:
  - 人工审查所有新增文件结构与内容
  - 验证进展脚本可连续运行
  - 修正脚本转义与参数解析问题后复测通过
- Files Reviewed:
  - `gptdeepsearch2_9.md`
  - `.claude.md`
  - `README.md`
  - `docs/REVIEW_CHECKLIST.md`
  - `scripts/append_progress.ps1`
  - `.gitignore`
  - `WORK_PROGRESS.md`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 主文档含时间边界与风险声明
  - [x] .claude.md 已建立交接规范
  - [x] 日志机制可用并留痕

## Entry 008
- Timestamp: 2026-02-09 14:50:47 +08:00
- Stage: Pre-commit gate
- Actions:
  - 完成文档与脚本自查
  - 确认将排除本地 workspace 文件
  - 准备执行首个提交
- Files Reviewed:
  - `gptdeepsearch2_9.md`
  - `.claude.md`
  - `README.md`
  - `scripts/append_progress.ps1`
  - `WORK_PROGRESS.md`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 质量门禁已执行
  - [x] 无阻塞项
  - [x] 可进入提交阶段

## Entry 009
- Timestamp: 2026-02-09 14:55:31 +08:00
- Stage: Push attempt
- Actions:
  - 完成首个本地提交
  - 尝试 HTTPS 推送失败（无可用交互凭证）
  - 验证当前环境无 gh CLI 且 SSH 公钥认证失败
- Files Reviewed:
  - `git status`
  - `git push output`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 本地提交已生成
  - [x] 阻塞原因已定位
  - [x] 等待用户提供凭证或手动推送

## Entry 010
- Timestamp: 2026-02-09 15:09:41 +08:00
- Stage: Push completed
- Actions:
  - 使用临时凭证完成远程推送
  - 确认 main 分支已建立 upstream
  - 未将凭证写入 git remote 配置
- Files Reviewed:
  - `git push output`
  - `git remote -v`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 远程推送成功
  - [x] 凭证未落盘到仓库文件
  - [x] 日志与状态一致

## Entry 011
- Timestamp: 2026-02-09 16:09:51 +08:00
- Stage: Scaffold and governance docs
- Actions:
  - 创建方向三要求的目录骨架
  - 新增 AGENTS.md 仓库契约
  - 新增 memory-cluster-patent-kit Skill 文件
- Files Reviewed:
  - `gptdeepsearch2_9.md`
  - `AGENTS.md`
- Files Changed:
  - `AGENTS.md`
  - `.codex/skills/memory-cluster-patent-kit/SKILL.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 目录结构满足第一阶段要求
  - [x] 规则文档可读可执行
  - [x] Skill 触发描述已覆盖关键关键词

## Entry 012
- Timestamp: 2026-02-09 16:34:39 +08:00
- Stage: Core prototype modules
- Actions:
  - 实现 src/memory_cluster 全部核心模块与 CLI
  - 补充 package 入口 (__main__.py)
  - 执行 compileall 语法自检通过
- Files Reviewed:
  - `gptdeepsearch2_9.md`
  - `src/memory_cluster/*.py`
- Files Changed:
  - `src/__init__.py`
  - `src/memory_cluster/__init__.py`
  - `src/memory_cluster/__main__.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/embed.py`
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/compress.py`
  - `src/memory_cluster/preference.py`
  - `src/memory_cluster/store.py`
  - `src/memory_cluster/retrieve.py`
  - `src/memory_cluster/eval.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 模块清单与文档要求一致
  - [x] 核心逻辑可导入
  - [x] 语法检查无错误

## Entry 013
- Timestamp: 2026-02-09 17:09:45 +08:00
- Stage: Examples, benchmark, and tests
- Actions:
  - 新增多 Agent 示例碎片与偏好配置
  - 新增 benchmark 脚本 scripts/run_benchmark.py
  - 新增 4 个核心测试并修复聚类阈值导致的失败
  - 使用 unittest 全量通过
- Files Reviewed:
  - `tests/*.py`
  - `data/examples/*.json*`
  - `src/memory_cluster/pipeline.py`
- Files Changed:
  - `data/examples/multi_agent_memory_fragments.jsonl`
  - `data/examples/preference_profile.json`
  - `scripts/run_benchmark.py`
  - `docs/eval/demo_walkthrough.md`
  - `tests/test_clustering_basic.py`
  - `tests/test_conflict_marking.py`
  - `tests/test_preference_policy.py`
  - `tests/test_store_roundtrip.py`
  - `requirements.txt`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 示例数据覆盖重复+冲突+噪声
  - [x] 四项指定测试均存在且通过
  - [x] 具备基准评测入口

## Entry 014
- Timestamp: 2026-02-09 17:14:38 +08:00
- Stage: Prior-art and patent kit drafting
- Actions:
  - 新增算法规格文档 docs/design/algorithm_spec.md
  - 生成 prior_art 三件套（search_log/feature_matrix/design_around）
  - 生成 patent_kit 00-08 全套中文草案
- Files Reviewed:
  - `gptdeepsearch2_9.md`
  - `docs/prior_art/*.md`
- Files Changed:
  - `docs/design/algorithm_spec.md`
  - `docs/prior_art/search_log.md`
  - `docs/prior_art/feature_matrix.md`
  - `docs/prior_art/design_around.md`
  - `docs/patent_kit/00_技术交底书_总览.md`
  - `docs/patent_kit/01_背景技术.md`
  - `docs/patent_kit/02_发明内容_技术问题与效果.md`
  - `docs/patent_kit/03_技术方案_系统与流程.md`
  - `docs/patent_kit/04_附图说明.md`
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/07_摘要.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] prior-art 条目数>=15
  - [x] 权利要求含方法+系统+介质独立项
  - [x] 文档含非法律意见边界

## Entry 015
- Timestamp: 2026-02-09 17:20:55 +08:00
- Stage: End-to-end validation and final report
- Actions:
  - 修复 CLI/benchmark 对 BOM 编码兼容问题
  - 修复 benchmark 脚本模块导入路径问题
  - 执行 ingest/build/query/eval/benchmark 全流程并生成 outputs
  - 新增 docs/FINAL_REPORT.md 汇总指标与风险雷达
- Files Reviewed:
  - `src/memory_cluster/cli.py`
  - `scripts/run_benchmark.py`
  - `outputs/*.json`
- Files Changed:
  - `src/memory_cluster/cli.py`
  - `src/memory_cluster/compress.py`
  - `scripts/run_benchmark.py`
  - `docs/eval/demo_walkthrough.md`
  - `docs/FINAL_REPORT.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 单元测试 4/4 通过
  - [x] 端到端命令可复现
  - [x] 关键指标与风险已入 FINAL_REPORT

## Entry 016
- Timestamp: 2026-02-09 17:21:51 +08:00
- Stage: Final QA snapshot
- Actions:
  - 执行 compileall 复查代码可编译
  - 核对 outputs 与 FINAL_REPORT 一致性
  - 准备向用户交付
- Files Reviewed:
  - `docs/FINAL_REPORT.md`
  - `outputs/benchmark.json`
  - `outputs/cluster_state.json`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 可编译
  - [x] 可复现
  - [x] 文档与实测数据一致

## Entry 017
- Timestamp: 2026-02-09 17:36:03 +08:00
- Stage: Script validation
- Actions:
  - [x] 参数验证已增强
  - [ ] 待后续回归
- Files Reviewed:
  - `scripts/append_progress.ps1`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [ ] (not provided)

## Entry 018
- Timestamp: 2026-02-09 17:47:54 +08:00
- Stage: R-004评审闭环与代码推进
- Actions:
  - 完成R-003评审意见取舍并落地
  - 实现检索排序增强(保留强度+新鲜度)+offset分页验证
  - 完成单测与CLI与benchmark回归
- Files Reviewed:
  - `src/memory_cluster/retrieve.py`
  - `tests/test_retrieve_ordering.py`
  - `gptdeepsearch2_9.md`
  - `docs/review_response_r003.md`
  - `docs/REVIEW_CHECKLIST.md`
- Files Changed:
  - `src/memory_cluster/retrieve.py`
  - `tests/test_retrieve_ordering.py`
  - `.gitignore`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 单元测试全通过(9/9)
  - [x] CLI build/query/eval可运行
  - [x] benchmark脚本回归通过
  - [x] 敏感信息扫描无命中

## Entry 019
- Timestamp: 2026-02-09 17:56:52 +08:00
- Stage: R-004提交与远端同步
- Actions:
  - 创建提交 b7ab315 并推送到 origin/main
  - 校验远端分支已更新并与本地同步
  - 确认未提交敏感凭证到仓库
- Files Reviewed:
  - `git status`
  - `git ls-remote`
  - `git remote -v`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 远端main包含最新提交
  - [x] 本地main与origin/main一致
  - [x] 凭证未写入仓库文件

## Entry 020
- Timestamp: 2026-02-09 23:49:20 +08:00
- Stage: R-005阶段推进：L2层次压缩与计划收敛
- Actions:
  - 完成L2层次簇实现(Parent/Child/Level)并开放CLI开关
  - 修正评测口径为L1主指标+all辅助指标
  - 新增检索层级过滤(all/l1/l2)与测试
  - 输出下一阶段计划评估文档 next_phase_plan.md 并同步README/主任务文档
- Files Reviewed:
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/eval.py`
  - `src/memory_cluster/retrieve.py`
  - `tests/test_retrieve_ordering.py`
  - `docs/FINAL_REPORT.md`
- Files Changed:
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/eval.py`
  - `src/memory_cluster/retrieve.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_l2_hierarchy.py`
  - `tests/test_retrieve_ordering.py`
  - `data/examples/preference_profile.json`
  - `docs/design/next_phase_plan.md`
  - `docs/FINAL_REPORT.md`
  - `README.md`
  - `gptdeepsearch2_9.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 单元测试 12/12 通过
  - [x] L2 build 命令可复现
  - [x] 查询层级过滤(l1/l2)可用
  - [x] benchmark与compileall通过

## Entry 021
- Timestamp: 2026-02-09 23:50:58 +08:00
- Stage: R-005提交与同步
- Actions:
  - 提交 18b6ab5：L2层次压缩+检索层级过滤+计划文档
  - 推送 main 到 origin 并校验远端commit一致
- Files Reviewed:
  - `git status`
  - `git rev-parse HEAD`
  - `git ls-remote origin refs/heads/main`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 本地与远端commit一致
  - [x] 未提交凭证文件

## Entry 022
- Timestamp: 2026-02-09 23:58:38 +08:00
- Stage: R-006授权潜力评估与申请策略
- Actions:
  - 基于法条+审查口径+先行技术组合完成授权潜力分级评估
  - 新增专门评估文档并给出分法域申请建议与时间窗建议
- Files Reviewed:
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/prior_art/feature_matrix.md`
  - `docs/prior_art/search_log.md`
  - `cnipa.gov.cn法条与AI指引页面`
- Files Changed:
  - `docs/patent_kit/09_授权潜力评估与下一步建议.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 结论含法域差异
  - [x] 风险点与法条对应
  - [x] 下一步建议可执行

## Entry 023
- Timestamp: 2026-02-10 00:00:01 +08:00
- Stage: R-006评估文档推送
- Actions:
  - 提交并推送授权潜力评估文档到origin/main
  - 校验远端commit与本地一致
- Files Reviewed:
  - `git status`
  - `git rev-parse HEAD`
  - `git ls-remote origin refs/heads/main`
- Files Changed:
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 远端同步成功
  - [x] 评估文档可追溯

## Entry 024
- Timestamp: 2026-02-10 00:05:30 +08:00
- Stage: R-007中国快申技术计划
- Actions:
  - 面向中国法域输出2周快申技术计划
  - 定义三项最小可行创新(CEG/ARB/DMG)及对应代码落点
  - 给出按天执行节奏与权利要求策略
- Files Reviewed:
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/prior_art/feature_matrix.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `docs/design/cn_fast_track_patent_plan.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 计划包含技术问题-手段-效果闭环
  - [x] 计划包含可执行时间表
  - [x] 计划包含可落地代码文件映射

## Entry 025
- Timestamp: 2026-02-10 00:12:41 +08:00
- Stage: R-008初学者人话说明
- Actions:
  - 新增初学者人话版说明文档
  - 将项目术语改写为生活化比喻并提供最短学习路径
  - 在README新增新手入口
- Files Reviewed:
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/compress.py`
  - `src/memory_cluster/retrieve.py`
  - `README.md`
- Files Changed:
  - `docs/design/beginner_plain_guide.md`
  - `README.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 语言面向零基础
  - [x] 包含项目逻辑与合理性解释
  - [x] 包含可直接运行命令

## Entry R-004-Review (Claude Opus)
- Timestamp: 2026-02-10 14:30:00 +08:00
- Stage: R-004 全量深度评审（by Claude Opus 4.6）
- Actions:
  - 逐行审读全部 13 个源码模块
  - 审读全部 8 个测试文件（12 个方法）
  - 运行 12/12 单元测试 — 全部通过
  - 执行 CLI 端到端验证（ingest→build→query）— 通过
  - 发现 Windows 控制台 GBK 编码导致中文输出乱码（数据本身正确）
  - 验证 R-003 的 12 项问题闭环状态：8 项已修复/标注，4 项降级遗留
  - 审读 3 份新增文档（beginner_plain_guide / cn_fast_track_patent_plan / review_response_r003）
  - 核对 WORK_PROGRESS Entry 018-025
  - 新发现 5 个 P2 问题 + 3 个 P3 问题
- Files Reviewed:
  - `src/memory_cluster/*.py`（全部 13 个）
  - `tests/test_*.py`（全部 8 个）
  - `docs/design/beginner_plain_guide.md`
  - `docs/design/cn_fast_track_patent_plan.md`
  - `docs/review_response_r003.md`
  - `docs/FINAL_REPORT.md`
  - `docs/REVIEW_CHECKLIST.md`
  - `README.md`
  - `gptdeepsearch2_9.md`
  - `AGENTS.md`
  - `WORK_PROGRESS.md`
  - `data/examples/multi_agent_memory_fragments.jsonl`
  - `data/examples/preference_profile.json`
- Files Changed:
  - `.claude.md`（追加 R-004 完整评审报告）
  - `WORK_PROGRESS.md`（本条目）
- Review Checklist:
  - [x] 代码整体评级: A-
  - [x] 测试整体评级: B-（需加强）
  - [x] 文档整体评级: A-
  - [x] R-003 闭环率: 67%
  - [x] 新发现 P2 项 5 个，P3 项 3 个
  - [x] 端到端运行验证通过
  - [x] 安全审查通过（无凭证泄漏、无注入风险）
  - [x] 自查 SC-004 完成

## Entry 026
- Timestamp: 2026-02-10 00:41:34 +08:00
- Stage: R-009创新实现与消融实验
- Actions:
  - 实现CEG冲突证据图(优先级/主导值/切换边)
  - 实现ARB自适应预算(冲突密度+来源熵+时效)
  - 实现DMG双通道合并门控并输出阻断统计
  - 新增消融实验脚本 run_ablation.py 并输出报告
  - 补17条单测全绿与CLI/benchmark回归
- Files Reviewed:
  - `src/memory_cluster/compress.py`
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/preference.py`
  - `scripts/run_ablation.py`
  - `tests/`
- Files Changed:
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/preference.py`
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/compress.py`
  - `src/memory_cluster/retrieve.py`
  - `src/memory_cluster/eval.py`
  - `src/memory_cluster/cli.py`
  - `scripts/run_ablation.py`
  - `tests/test_conflict_graph_and_budget.py`
  - `tests/test_dual_merge_guard.py`
  - `tests/test_protected_preferences.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_explained_cn.md`
  - `docs/FINAL_REPORT.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
- Review Checklist:
  - [x] 单元测试17/17通过
  - [x] ablation脚本可复现
  - [x] benchmark回归通过
  - [x] 关键结论有数据支撑

## Entry R-005-Review (Claude Opus)
- Timestamp: 2026-02-10 15:30:00 +08:00
- Stage: R-005 创新代码评审（by Claude Opus 4.6）
- Actions:
  - 审读 CEG/ARB/DMG 三创新实现的 7 个变更模块
  - 验证 CEG priority 公式、ARB scale 公式、DMG Jaccard 兼容性逻辑
  - 审读 3 个新测试文件（5 个方法）
  - 运行 17/17 单元测试 — 全部通过
  - 审读消融实验脚本（300 行）和报告
  - 发现保护偏好可被 source_weight/staleness 覆盖的逻辑问题（P2-NEW-9）
- Files Reviewed:
  - `src/memory_cluster/models.py`（变更部分）
  - `src/memory_cluster/compress.py`（CEG 实现）
  - `src/memory_cluster/cluster.py`（DMG 实现）
  - `src/memory_cluster/preference.py`（ARB + 保护偏好）
  - `src/memory_cluster/pipeline.py`（集成变更）
  - `src/memory_cluster/eval.py`（新指标）
  - `src/memory_cluster/cli.py`（新参数）
  - `tests/test_conflict_graph_and_budget.py`
  - `tests/test_dual_merge_guard.py`
  - `tests/test_protected_preferences.py`
  - `scripts/run_ablation.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_explained_cn.md`
- Files Changed:
  - `.claude.md`（追加 R-005 评审报告）
  - `WORK_PROGRESS.md`（本条目）
- Review Checklist:
  - [x] CEG 评级 A-：图结构+优先级计算正确
  - [x] ARB 评级 A：公式数学正确，参数全部可配置
  - [x] DMG 评级 A-：双通道门控+统计输出完整
  - [x] 消融实验评级 A-：5 场景覆盖，增量增益清晰
  - [x] 17/17 测试全绿
  - [x] P2-NEW-9 保护降级覆盖问题已标注
  - [x] 自查 SC-005 完成

## Entry 027
- Timestamp: 2026-02-10 00:52:12 +08:00
- Stage: P2-NEW-9修复与一致性更新
- Actions:
  - 修复 `preference.py` 中 protected 片段可被 source/staleness 降级覆盖的问题
  - 新增回归测试：保护片段在低权重且过期条件下仍保持 `strong`
  - 全量回归测试通过（18/18）
  - 同步更新文档中的测试计数（`FINAL_REPORT.md`, `next_phase_plan.md`）
- Files Reviewed:
  - `src/memory_cluster/preference.py`
  - `tests/test_protected_preferences.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `src/memory_cluster/preference.py`
  - `tests/test_protected_preferences.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Review Checklist:
  - [x] 保护命中后不再执行降级路径
  - [x] 保护逻辑新增回归测试
  - [x] 全量测试18/18通过
  - [x] 文档计数与测试结果一致

## Entry R-007-Research (Claude Opus)
- Timestamp: 2026-02-10 17:30:00 +08:00
- Stage: R-007 快申计划第 7-9 天准备性深度研究（by Claude Opus 4.6）
- Actions:
  - 运行消融实验获取最新指标数据（5 场景全部运行成功）
  - 审读全部 10 个 patent_kit 文件 + 3 个 eval 文件
  - 分析 FULL 场景压缩回归根因（compression_ratio=0.974）
  - 确认 dedup_reduction=0 为合成数据特性（非 bug）
  - 评估快申计划第 7-9 天交付物完成度
  - 识别 2 个 P0 专利缺口 + 2 个 P1 更新需求 + 4 个 P2 增强建议
  - 提供"最接近现有技术-区别特征-技术效果"三联对比表草案
  - 深度分析代码边界行为（trace_refs 溢出、DMG 无共同 slot、特殊阈值参数）
- Files Reviewed:
  - `docs/patent_kit/*.md`（全部 10 个）
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_explained_cn.md`
  - `docs/eval/demo_walkthrough.md`
  - `docs/design/cn_fast_track_patent_plan.md`
  - `scripts/run_ablation.py`
  - `outputs/ablation_metrics.json`（运行生成）
  - `src/memory_cluster/compress.py`（边界分析）
  - `src/memory_cluster/cluster.py`（边界分析）
  - `src/memory_cluster/pipeline.py`（流程追踪）
  - `src/memory_cluster/preference.py`（验证 P2-NEW-9 修复持续有效）
  - `src/memory_cluster/eval.py`（dedup_reduction 逻辑追踪）
- Files Changed:
  - `.claude.md`（追加 R-007 研究报告 + 三联对比表草案）
  - `WORK_PROGRESS.md`（本条目）
- Review Checklist:
  - [x] 消融实验 5 场景全部运行成功
  - [x] 18/18 测试全绿（验证项目稳定性）
  - [x] FULL 压缩回归根因明确（trade-off，非 bug）
  - [x] patent_kit 10 文件逐一审读
  - [x] P0 缺口识别：08 三联表 + 05 量化数据
  - [x] P1 更新：09 评估过时 + FULL trade-off 文档化
  - [x] 三联对比表草案已提供（含 4 个对比文件逐行对比）
  - [x] 权利要求 14-16 增强建议已提供
  - [x] 自查 SC-007 完成

## Entry 028
- Timestamp: 2026-02-10 01:18:47 +08:00
- Stage: 合并阶段算法优化（Merge Upper-Bound Prune）
- Actions:
  - 在 `cluster.py` 合并流程加入余弦上界剪枝（安全剪枝，不改变正确性）
  - 新增指标 `merge_pairs_pruned_by_bound`，用于量化剪枝收益
  - 将剪枝能力接入配置与 CLI 开关（默认关闭，按需开启）
  - 新增 `test_merge_upper_bound_prune.py`（结果一致性 + 剪枝触发）
  - 新增性能对照脚本 `scripts/run_prune_benchmark.py`
  - 运行对照实验并生成 `docs/eval/prune_benchmark_report.md`
- Files Reviewed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_upper_bound_prune.py`
  - `scripts/run_prune_benchmark.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `README.md`
- Files Changed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_upper_bound_prune.py`
  - `scripts/run_prune_benchmark.py`
  - `docs/eval/prune_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `README.md`
  - `data/examples/preference_profile.json`
- Review Checklist:
  - [x] 新增单测通过（merge prune: 2/2）
  - [x] 全量单测通过（20/20）
  - [x] 默认配置无回归（benchmark latest 2.495ms 平均）
  - [x] 对照实验可复现并产出报告
  - [x] 结果一致性验证（cluster_count_equal=true）

## Entry 029
- Timestamp: 2026-02-10 10:21:33 +08:00
- Stage: 专利算法进展快照与严格评审清单交付
- Actions:
  - 汇总当前算法任务完成度（CEG/ARB/DMG/L2/Prune + 测试 + 实验）
  - 生成可直接交由 Claude4.6 执行的严格评审清单
  - 清单覆盖：P0 gate、模块级审查、测试充分性、性能复现、专利一致性、输出模板
- Files Reviewed:
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `src/memory_cluster/*.py`
  - `tests/test_*.py`
  - `docs/patent_kit/*.md`
- Files Changed:
  - `docs/review/claude46_strict_review_checklist.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 进展快照与当前代码状态一致
  - [x] 清单可直接执行（含命令与通过标准）
  - [x] 覆盖专利导向审查项（问题-手段-效果）

## Entry 030
- Timestamp: 2026-02-10 10:27:47 +08:00
- Stage: 自查漏洞与专利潜力自评（等待 Claude 对比前）
- Actions:
  - 执行凭证/危险API快速扫描与全量单测
  - 输出分级风险清单（P1/P2/P3）与已修复项
  - 给出中国法域下的专利潜力技术评估
  - 预置下一轮 Claude 评审差异对比模板
- Files Reviewed:
  - `src/memory_cluster/store.py`
  - `src/memory_cluster/retrieve.py`
  - `src/memory_cluster/cli.py`
  - `src/memory_cluster/compress.py`
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
  - `docs/patent_kit/09_授权潜力评估与下一步建议.md`
- Files Changed:
  - `tests/test_retrieve_ordering.py`
  - `docs/review/self_audit_patent_potential_r010.md`
  - `docs/review/claude_review_diff_template.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 单测通过（21/21）
  - [x] 风险按优先级分级
  - [x] 专利潜力结论可追溯
  - [x] Claude 对比模板可直接使用

## Entry 031
- Timestamp: 2026-02-10 10:27:47 +08:00
- Stage: 对齐 Claude R-008 评审并修复高优先问题
- Actions:
  - 修复 prune benchmark 报告与 JSON 不一致问题（同次 payload 生成报告）
  - 增加多场景 benchmark：merge_active / realistic_068_082 / sparse_no_merge
  - 新增 `merge_activity_present` 指标，避免 `cluster_count_equal` 空结论
  - 抽取共享时间解析工具 `time_utils.parse_iso_utc`
  - 补充专利文档：05 量化结果、08 三联表、06 新增权利要求17
  - 产出 Claude 评审对照响应文档
- Files Reviewed:
  - `scripts/run_prune_benchmark.py`
  - `outputs/prune_benchmark.json`
  - `docs/eval/prune_benchmark_report.md`
  - `src/memory_cluster/retrieve.py`
  - `src/memory_cluster/preference.py`
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
- Files Changed:
  - `scripts/run_prune_benchmark.py`
  - `docs/eval/prune_benchmark_report.md`
  - `src/memory_cluster/time_utils.py`
  - `src/memory_cluster/retrieve.py`
  - `src/memory_cluster/preference.py`
  - `tests/test_time_utils.py`
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
  - `docs/patent_kit/09_授权潜力评估与下一步建议.md`
  - `docs/review/r008_response_codex.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Review Checklist:
  - [x] 评审 P1 项可复现修复
  - [x] 报告与 JSON 同步
  - [x] 23/23 测试通过
  - [x] 专利文档缺口补齐（本轮范围）

## Entry 032
- Timestamp: 2026-02-10 11:12:35 +08:00
- Stage: 可靠性闸门第1阶段（ingest 幂等 + 容错）
- Actions:
  - `store.py` 新增幂等写入与统计输出（按 `id+version` 去重）
  - `store.py` 新增 JSONL 容错读取与 strict 模式
  - 引入轻量 lock 文件机制，保护写入临界区
  - `cli ingest/build` 新增严格开关与统计回传（`--idempotent`, `--strict-input`, `--strict-store`）
  - 新增 `test_store_reliability.py`（幂等、坏行容错、strict、BOM 兼容）
  - 文档同步（README、FINAL_REPORT、next_phase_plan）
- Files Reviewed:
  - `src/memory_cluster/store.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_store_reliability.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `src/memory_cluster/store.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_store_reliability.py`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `docs/review/self_audit_patent_potential_r010.md`
- Review Checklist:
  - [x] 幂等写入行为可测
  - [x] 容错与 strict 两种模式均可用
  - [x] 全量测试通过（28/28）
  - [x] CLI 输出包含可审计统计字段

## Entry R-008-StrictReview (Claude Opus)
- Timestamp: 2026-02-10 19:00:00 +08:00
- Stage: R-008 全量严格评审（by Claude Opus 4.6，按 claude46_strict_review_checklist.md 执行）
- Actions:
  - P0 门禁 6/6 全部实际运行验证：21/21 单测、编译、ablation、prune benchmark、E2E CLI、指标文件
  - CEG/ARB/DMG/Prune 四创新逐行审读 + 数学验证（Prune Cauchy-Schwarz 上界正确性确认）
  - 13 个源码模块 + 11 个测试文件逐文件审查
  - Prune benchmark 深度分析：发现 similarity_threshold=2.0 导致 merges_applied=0，cluster_count_equal 恒真
  - Prune benchmark report.md (5.7%) 与 JSON (18.9%) 数据不一致（不同次运行）
  - 专利一致性核查 + 安全审查
  - 输出 P0:0 / P1:2 / P2:8 / P3:5 分级结论，全部含文件:行号证据
  - 完整评审报告写入 .claude.md（R-008 条目）
- Files Reviewed:
  - `src/memory_cluster/*.py`（全部 13 个）
  - `tests/test_*.py`（全部 11 个）
  - `scripts/run_prune_benchmark.py`
  - `scripts/run_ablation.py`
  - `docs/eval/prune_benchmark_report.md`
  - `docs/review/claude46_strict_review_checklist.md`
  - `docs/patent_kit/*.md`（一致性核查）
  - `outputs/prune_benchmark.json`
  - `outputs/ablation_metrics.json`
- Files Changed:
  - `.claude.md`（追加 R-008 全量严格评审报告）
  - `WORK_PROGRESS.md`（本条目）
- Review Checklist:
  - [x] P0 门禁 6/6 PASS
  - [x] 算法完成度 CEG/ARB/DMG/Prune 全部 PASS
  - [x] Prune 上界数学正确性验证 PASS
  - [x] 21/21 测试全绿
  - [x] P1-1 Prune benchmark 空洞验证已标注
  - [x] P1-2 报告/JSON 不一致已标注
  - [x] 按 checklist §8 模板输出完整 Findings/Evidence/Gates/Fix/Risks
  - [x] 自查 SC-008 完成

## Entry R-009-Review (Claude Opus)
- Timestamp: 2026-02-10 20:00:00 +08:00
- Stage: R-009 验证评审 — Codex R-011/R-012 审读（by Claude Opus 4.6）
- Actions:
  - R-008 10 项问题闭环验证：P1 全部关闭，P2 修复 4 项 / 暂缓 3 项
  - store.py 203 行逐行审读：_FileLock (O_EXCL) + 幂等 append + 容错 read + stats
  - time_utils.py 去重统一验证
  - prune benchmark 3 场景数据交叉验证（primary 有真正 merge 确认）
  - patent_kit 05/06/08 更新审读
  - 新增测试审查（test_store_reliability 5 方法 + test_time_utils 2 方法）
  - 28/28 测试全量运行通过
  - 新发现 P2:1 项 + P3:4 项
- Files Reviewed:
  - `src/memory_cluster/store.py`（全文）
  - `src/memory_cluster/cli.py`（全文）
  - `src/memory_cluster/time_utils.py`
  - `src/memory_cluster/preference.py`（wrapper 验证）
  - `src/memory_cluster/retrieve.py`（import 验证）
  - `tests/test_store_reliability.py`
  - `tests/test_time_utils.py`
  - `docs/review/r008_response_codex.md`
  - `docs/eval/prune_benchmark_report.md`
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
  - `outputs/prune_benchmark.json`
- Files Changed:
  - `.claude.md`（追加 R-009 评审报告）
  - `WORK_PROGRESS.md`（本条目）
- Review Checklist:
  - [x] R-008 P1 全部关闭确认
  - [x] R-012 store.py 可靠性方案审读
  - [x] _FileLock 原子性分析
  - [x] 幂等 (id,version) 去重逻辑验证
  - [x] prune benchmark 3 场景验证
  - [x] patent_kit 更新审读
  - [x] 28/28 测试全绿
  - [x] 自查 SC-009 完成

## Entry R-013
- Timestamp: 2026-02-10 11:49:27 +08:00
- Stage: 第二阶段推进（冲突语义增强 + 大样本消融 + 报告同步）
- Actions:
  - `compress.py` 新增否定/条件/反事实语义抽取规则，支持 `cond:` 与 `cf:` 作用域槽位。
  - 新增 `tests/test_conflict_semantics.py`，覆盖否定值抽取、条件作用域隔离、反事实作用域抽取。
  - `run_ablation.py` 参数化改造（fragment count / thresholds / dataset label）。
  - 复跑实验并同步报告：
    - `docs/eval/ablation_report_cn.md`（9 样本）
    - `docs/eval/ablation_report_large_cn.md`（100 样本 realistic）
    - `docs/eval/ablation_report_stress_cn.md`（100 样本 stress）
    - `docs/eval/prune_benchmark_report.md`（与 JSON 同次运行）
  - 更新交付与计划文档：`README.md`、`docs/FINAL_REPORT.md`、`docs/design/next_phase_plan.md`。
- Files Reviewed:
  - `src/memory_cluster/compress.py`
  - `scripts/run_ablation.py`
  - `scripts/run_prune_benchmark.py`
  - `tests/test_conflict_semantics.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_report_large_cn.md`
  - `docs/eval/ablation_report_stress_cn.md`
  - `docs/eval/prune_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `src/memory_cluster/compress.py`
  - `scripts/run_ablation.py`
  - `tests/test_conflict_semantics.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_report_large_cn.md`
  - `docs/eval/ablation_report_stress_cn.md`
  - `docs/eval/prune_benchmark_report.md`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `.claude.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 语义增强规则代码自查完成（无重复函数/无编码损坏）
  - [x] 新增语义单测通过（31/31）
  - [x] `python -m compileall src tests scripts` 通过
  - [x] ablation/prune 报告与对应 JSON 同次重跑
  - [x] 第二阶段文档与计划已同步

## Entry R-014
- Timestamp: 2026-02-10 13:06:08 +08:00
- Stage: R-010 评审意见修复（P1/P2 关闭）
- Actions:
  - 修复 `NEGATED_KEY_VALUE_PATTERN` 前缀顺序，避免“不是 mode=fast”误提取为 slot=`是`。
  - 修复 flag 抽取作用域污染：全局 flag 抽取加入 `masked_spans` 过滤。
  - 增强条件/反事实内否定语义：支持 `cond:slot=!value`、`cf:slot=!value` 与作用域 flag。
  - `run_ablation.py` 报告 summary 改为可读指标行 + Raw JSON 附录。
  - 新增中文语义测试（否定/条件/反事实）并修复 `test_edge_cases.py` 乱码用例。
- Files Reviewed:
  - `src/memory_cluster/compress.py`
  - `tests/test_conflict_semantics.py`
  - `tests/test_edge_cases.py`
  - `scripts/run_ablation.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_report_large_cn.md`
  - `docs/eval/ablation_report_stress_cn.md`
- Files Changed:
  - `src/memory_cluster/compress.py`
  - `tests/test_conflict_semantics.py`
  - `tests/test_edge_cases.py`
  - `scripts/run_ablation.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_report_large_cn.md`
  - `docs/eval/ablation_report_stress_cn.md`
  - `.claude.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] P1-1 正则优先级修复
  - [x] P2-1 flag 作用域污染修复
  - [x] P2-2 作用域内否定语义保留
  - [x] P2-3 中文语义测试补齐
  - [x] P2-4 消融报告 summary 可读化
  - [x] 全量测试通过（35/35）
  - [x] 编译检查通过

## Entry R-010-DeepReview
- Timestamp: 2026-02-10 ~23:30 +08:00
- Stage: Stage 1 + Stage 2 综合深度评估
- Reviewer: Claude Opus 4.6
- Actions:
  - 拉取并验证 d5738b6 全量代码
  - 深度审查 compress.py 冲突语义增强（4 新正则 + masked_spans）
  - 验证 test_conflict_semantics.py (3 tests)
  - 验证 run_ablation.py 参数化 + 100 样本生成
  - 交叉验证 3 套消融实验 + prune 对照实验数据
  - 运行 31/31 测试通过 + compileall 通过
  - 发现 P1-1 正则 alternation order bug 并实测验证
  - 撰写综合深度评估报告
- Files Reviewed:
  - src/memory_cluster/compress.py (381 lines)
  - tests/test_conflict_semantics.py (46 lines)
  - scripts/run_ablation.py (447 lines)
  - docs/eval/ablation_report_cn.md
  - docs/eval/ablation_report_large_cn.md
  - docs/eval/ablation_report_stress_cn.md
  - docs/eval/prune_benchmark_report.md
  - docs/FINAL_REPORT.md
  - docs/design/next_phase_plan.md
- Files Changed:
  - docs/review/r010_stage1_stage2_deep_review.md (NEW)
  - .claude.md (R-010 entry added)
  - WORK_PROGRESS.md (this entry)
- Key Findings:
  - P1-1: NEGATED_KEY_VALUE_PATTERN alternation order bug (中文否定)
  - P2-1: Flag patterns ignore masked_spans
  - P2-2: Negation-in-scope semantic loss
  - P2-3: No Chinese test coverage
  - P2-4: Ablation report Summary raw JSON
- Overall Rating: B+ (P1 fix required before next stage)
- Review Checklist:
  - [x] 31/31 tests pass
  - [x] compileall pass
  - [x] Regex behavior verified with manual tests
  - [x] Experiment data cross-validated
  - [x] Comprehensive review written to docs/review/
  - [x] .claude.md updated with R-010 entry

## Entry R-015
- Timestamp: 2026-02-10 13:40:22 +08:00
- Stage: 性能工程推进（候选筛选降耗原型）
- Actions:
  - 新增 merge 候选筛选配置：`enable_merge_candidate_filter`、`merge_candidate_bucket_dims`、`merge_candidate_max_neighbors`。
  - 在 `cluster.py` 合并循环中加入签名桶候选图，减少无效 pair 比较。
  - 新增审计指标：`merge_pairs_skipped_by_candidate_filter`。
  - CLI build 新增参数：`--enable-merge-candidate-filter`、`--merge-candidate-bucket-dims`、`--merge-candidate-max-neighbors`。
  - 新增单测：`tests/test_merge_candidate_filter.py`。
  - 新增 benchmark 脚本与报告：
    - `scripts/run_candidate_filter_benchmark.py`
    - `docs/eval/candidate_filter_benchmark_report.md`
  - 更新文档：`README.md`、`docs/FINAL_REPORT.md`、`docs/design/next_phase_plan.md`。
- Files Reviewed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_candidate_filter.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `docs/eval/candidate_filter_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_candidate_filter.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `docs/eval/candidate_filter_benchmark_report.md`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `.claude.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 新增候选筛选开关默认关闭（exact 模式保留）
  - [x] 新增指标可观测（skip pair 计数）
  - [x] 新增单测通过
  - [x] 全量测试通过（38/38）
  - [x] compileall 通过
  - [x] benchmark 报告已生成并记录参数

## Entry R-010b-Verification
- Timestamp: 2026-02-10
- Stage: R-010 修复验证 + 阶段决策
- Reviewer: Claude Opus 4.6
- Actions:
  - 验证 191b7cd 对 R-010 全部 5 项发现的修复
  - P1-1 正则 alternation order: 已修复 (最长优先)
  - P2-1 flag masked_spans: 已修复 (_add_flag_pairs_from_text)
  - P2-2 条件内否定: 已修复 (作用域内运行否定模式)
  - P2-3 中文测试: 已修复 (4 个新测试 s4-s7)
  - P2-4 报告格式: 已修复 (结构化 key-value)
  - 35/35 测试通过
- Decision: **确认可以进入下一阶段**
- Rating: A- (从 B+ 提升)
- Review Checklist:
  - [x] P1-1 修复实测验证通过
  - [x] P2-1/P2-2/P2-3/P2-4 全部验证通过
  - [x] 35/35 tests pass
  - [x] .claude.md updated with R-010b

## Entry R-016
- Timestamp: 2026-02-11 01:00:30 +08:00
- Stage: 语义精度回归推进（规则增强 + 回归证据）
- Actions:
  - `compress.py` 新增语义规则增强：
    - 条件后件截断（`then/则/那么` 后不进入 `cond:*`）
    - 英文否定 `not key=value` 提取
    - 双重否定窗口保护（如 `do not disable cache`）
    - 跨句指代槽位回指（`it/this/that/它/其/该参数`）
  - 新增回归单测：`tests/test_semantic_precision_regression.py`（6 条）
  - 新增回归脚本：`scripts/run_semantic_regression.py`
  - 生成回归证据：
    - `outputs/semantic_regression_metrics.json`
    - `docs/eval/semantic_regression_report.md`
  - 更新文档：`README.md`、`docs/FINAL_REPORT.md`、`docs/design/next_phase_plan.md`
- Files Reviewed:
  - `src/memory_cluster/compress.py`
  - `tests/test_semantic_precision_regression.py`
  - `scripts/run_semantic_regression.py`
  - `docs/eval/semantic_regression_report.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `README.md`
- Files Changed:
  - `src/memory_cluster/compress.py`
  - `tests/test_semantic_precision_regression.py`
  - `scripts/run_semantic_regression.py`
  - `docs/eval/semantic_regression_report.md`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 新增语义规则均有测试覆盖
  - [x] 语义回归脚本输出 JSON 与 Markdown 报告
  - [x] 全量单测通过（44/44）
  - [x] compileall 通过
  - [x] 关键指标可追溯（8/8 case, forbidden_violations=0）

## Entry R-017
- Timestamp: 2026-02-11 01:09:18 +08:00
- Stage: 第二阶段推进（ANN 混合候选 + 三方对照实验）
- Actions:
  - 新增 ANN 候选开关与参数链路（models/pipeline/cli/cluster 全链路接入）。
  - `cluster.py` 增加 ANN 多表签名候选构建，并支持 candidate/ann/hybrid 三种门控模式。
  - 新增指标：
    - `merge_pairs_skipped_by_ann_candidates`
    - `merge_pairs_skipped_by_hybrid_candidates`
  - 新增测试：`tests/test_merge_ann_candidates.py`（3 条）
  - 新增 benchmark：`scripts/run_ann_hybrid_benchmark.py`
  - 生成实验证据：
    - `outputs/ann_hybrid_benchmark.json`
    - `docs/eval/ann_hybrid_benchmark_report.md`
  - 更新文档：`README.md`、`docs/FINAL_REPORT.md`、`docs/design/next_phase_plan.md`
- Files Reviewed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `README.md`
- Files Changed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 全量单测通过（47/47）
  - [x] compileall 通过
  - [x] ANN 三方对照实验可复现并产出报告
  - [x] 质量门槛可审计（cluster/merge/conflict 一致性）
  - [x] 第二阶段结论已落地文档（ANN 默认关闭，candidate+prune 推荐）

## Entry R-018
- Timestamp: 2026-02-11 09:21:07 +08:00
- Stage: 专利证据收口（自动化映射 + 文本对齐）
- Actions:
  - 新增证据包生成脚本：`scripts/build_patent_evidence_pack.py`。
  - 自动生成统一证据产物：
    - `outputs/patent_evidence_pack.json`
    - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `06_权利要求书_草案.md` 新增权利要求18/19/20（候选筛选、ANN 混合、语义精度回归）。
  - `05_具体实施方式.md` 新增实施例五/六量化结果。
  - `08_对比文件与绕开说明.md` 增补 R-017 差异化条目。
  - `00_技术交底书_总览.md` 增加第10号文档索引。
  - 同步文档：`README.md`、`docs/FINAL_REPORT.md`、`docs/design/next_phase_plan.md`、`09_授权潜力评估与下一步建议.md`。
- Files Reviewed:
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
  - `docs/patent_kit/09_授权潜力评估与下一步建议.md`
  - `outputs/ablation_metrics*.json`
  - `outputs/prune_benchmark.json`
  - `outputs/candidate_filter_benchmark.json`
  - `outputs/ann_hybrid_benchmark.json`
  - `outputs/semantic_regression_metrics.json`
- Files Changed:
  - `scripts/build_patent_evidence_pack.py`
  - `outputs/patent_evidence_pack.json`
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `docs/patent_kit/00_技术交底书_总览.md`
  - `docs/patent_kit/05_具体实施方式.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/08_对比文件与绕开说明.md`
  - `docs/patent_kit/09_授权潜力评估与下一步建议.md`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 证据包由脚本自动生成，避免手工抄写
  - [x] 权利要求与证据条目一一映射（14~20）
  - [x] 全量测试通过（47/47）
  - [x] compileall 通过
  - [x] 证据脚本重跑通过并产出最新文件

## Entry R-011 (Opus Review)
- Timestamp: 2026-02-11
- Stage: Stage 3 Merge Candidate Filter 深度评估
- Reviewer: Claude Opus 4.6
- Baseline: commit 6d0ed35, 38/38 tests
- Actions:
  - 审查 9 文件 ~788 行变更：cluster.py 候选筛选核心、models/pipeline/cli 接入层、测试、benchmark
  - 运行 38/38 全量测试通过（0.506s）
  - 5 个手动验证脚本实测：签名退化、近零维度召回风险、对称化膨胀、HashEmbedding 分布、全量签名统计
  - **发现 P1-1（严重）**：`_candidate_signature` 符号位量化 `v >= 0.0` 与 HashEmbeddingProvider（全非负输出）不兼容，120 fragment 签名全退化为 (1,1,...,1)，桶化机制失效
  - **发现 ANN 同源问题**：`_ann_signature` 使用相同量化策略，存在同样退化
  - 发现 P2-1/P2-2/P2-3 共 3 个中优先级问题
  - 综合评级 B+，Stage 3 工程骨架合格但签名函数需修复
  - 撰写完整评审文档：`docs/review/r011_stage3_candidate_filter_review.md`（325 行，10 节）
- Files Reviewed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `src/memory_cluster/embed.py`
  - `tests/test_merge_candidate_filter.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `docs/eval/candidate_filter_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
- Files Changed:
  - `docs/review/r011_stage3_candidate_filter_review.md` (NEW, 325 行)
  - `.claude.md` (追加 R-011 条目)
  - `WORK_PROGRESS.md` (追加 R-011 条目)
- Review Checklist:
  - [x] 38/38 测试通过
  - [x] compileall 通过
  - [x] 手动签名退化验证（5 脚本）
  - [x] P1-1 根因分析到 embed.py 源码级别
  - [x] 评审文档写入并包含附录验证数据
  - [x] .claude.md 和 WORK_PROGRESS.md 已同步

## Entry R-019
- Timestamp: 2026-02-11 10:49:51 +08:00
- Stage: R-011 问题修复收口 + 全链路重算校验
- Actions:
  - 完成 `cluster.py` 候选筛选与 ANN 签名修复后的收口验证（签名退化防护、邻居上限约束、增量邻居刷新逻辑）。
  - `run_candidate_filter_benchmark.py` 增加 `merges_applied_equal` 汇总指标并写入 Markdown。
  - 重跑全套实验脚本，确保报告与 JSON 同轮次：
    - `run_ablation.py`（small/large/stress）
    - `run_prune_benchmark.py`
    - `run_candidate_filter_benchmark.py`
    - `run_ann_hybrid_benchmark.py`
    - `run_semantic_regression.py`
    - `build_patent_evidence_pack.py`
  - 修正证据文案一致性：
    - DF-05 从“保持结果一致”改为“稀疏一致 + active 可量化漂移”
    - 默认推荐路径调整为 `prune_only (exact merge)`，Candidate Filter 标记为按场景调参启用
  - 同步 `docs/FINAL_REPORT.md` 与 `docs/design/next_phase_plan.md` 最新结果与决策。
- Files Reviewed:
  - `src/memory_cluster/cluster.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/build_patent_evidence_pack.py`
  - `docs/eval/*.md`（ablation/prune/candidate/ann/semantic）
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `src/memory_cluster/cluster.py`
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/build_patent_evidence_pack.py`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_report_large_cn.md`
  - `docs/eval/ablation_report_stress_cn.md`
  - `docs/eval/prune_benchmark_report.md`
  - `docs/eval/candidate_filter_benchmark_report.md`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/eval/semantic_regression_report.md`
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `.claude.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] 全量单测通过（51/51）
  - [x] compileall 通过
  - [x] benchmark/report 与 JSON 同轮次重算
  - [x] DF-05/ANN 文案与指标一致性修复
  - [x] 进度日志含时间戳、动作、审阅清单

## Entry R-020
- Timestamp: 2026-02-11 11:14:38 +08:00
- Stage: R-019 严格评审对齐修复（P1 收口 + 数据刷新）
- Actions:
  - 采纳 P1 建议：将候选筛选默认 `merge_candidate_max_neighbors` 提升至 48（`models.py` / `cluster.py` / benchmark 默认参数）。
  - 恢复严格断言测试：
    - `test_candidate_filter_keeps_merge_outcome_on_active_case`
    - 断言 `cluster_count` 与 `merges_applied` 与 baseline 严格一致。
  - 优化候选邻居构图流程：
    - 合并“桶内候选 + 全局探索候选”后再统一重排截断，避免桶内先占满名额导致的召回损失。
    - 同步更新增量刷新路径中的单簇重算逻辑。
  - 重跑并刷新全链路产物：
    - benchmark / prune / ablation / semantic / evidence pack
    - `docs/eval/*.md` 与 `outputs/*.json` 时间戳对齐
  - 同步文档：
    - `docs/FINAL_REPORT.md`（Section 3.2/3.4/3.6/3.8 最新数据）
    - `docs/design/next_phase_plan.md`（Candidate Filter 状态改为“质量等效已恢复，性能待优化”）
    - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`（DF-05 文案改为动态与指标一致）
- Files Reviewed:
  - `docs/review/r019_stage3_ann_hybrid_patent_review.md`
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `tests/test_merge_candidate_filter.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `scripts/build_patent_evidence_pack.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `tests/test_merge_candidate_filter.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `scripts/build_patent_evidence_pack.py`
  - `README.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `docs/eval/ablation_report_cn.md`
  - `docs/eval/ablation_report_large_cn.md`
  - `docs/eval/ablation_report_stress_cn.md`
  - `docs/eval/prune_benchmark_report.md`
  - `docs/eval/candidate_filter_benchmark_report.md`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/eval/semantic_regression_report.md`
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `WORK_PROGRESS.md`
  - `.claude.md`
- Review Checklist:
  - [x] 恢复候选筛选严格断言并通过
  - [x] 全量单测通过（51/51）
  - [x] compileall 通过
  - [x] FINAL_REPORT 数值与最新 JSON 一致
  - [x] 专利证据文案与指标一致（无“口径大于数据”）

## Entry R-021
- Timestamp: 2026-02-11 12:30:42 +08:00
- Stage: R-020 严格评审复核 + 专利策略重规划
- Actions:
  - 审阅 `docs/review/r020_stage3_bucket_value_exploratory_review.md` 并逐条技术复核。
  - 对当前实现做签名质量快速实测（240 embedding）：
    - candidate unique ratio = 10/240 = 4.17%
    - candidate max bucket ratio = 197/240 = 82.08%
    - ann(table0) unique ratio = 12/240 = 5.00%
    - ann(table0) max bucket ratio = 107/240 = 44.58%
  - 结论：`_bucket_value` 在 HashEmbedding 稀疏非负向量上出现严重退化，R-020 的 P0-1 判定成立。
  - 结论：候选筛选当前通过 exploratory 全局排序保障等效，但复杂度退化至 O(k^2)；作为性能优化主张不成立。
  - 输出下一阶段双轨计划：
    - 工程轨：先修复签名退化，再做性能回收；
    - 专利轨：核心主张收敛到 CEG/ARB/DMG/语义冲突抽取 4 条。
- Files Reviewed:
  - `docs/review/r020_stage3_bucket_value_exploratory_review.md`
  - `src/memory_cluster/cluster.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Review Checklist:
  - [x] 是否复现实测 P0-1：是
  - [x] 是否判断测试严谨性缺口：是
  - [x] 是否形成专利与工程分离决策：是
  - [x] 是否给出可执行下一步计划：是

## Entry R-019 Opus (Opus Review)
- Timestamp: 2026-02-11
- Stage: Stage 3 ANN 混合候选 + 证据包 + P1-1 修复验证 全面评审
- Reviewer: Claude Opus 4.6
- Baseline: commits e3ea9dd, f6e644d + Codex R-019 hot-fix, 51/51 tests
- Actions:
  - 审查 16+ 文件 ~1200+ 行变更：cluster.py ANN 模块、_signed_projection、增量邻居刷新、证据包
  - 运行 51/51 全量测试（首次发现 2 个失败，后 Codex 推送热修后 51/51 通过）
  - P1-1 修复验证：ANN 签名 dim=128 产生 8/16 不同签名 ✓，候选签名 2/6 不同 ✓
  - **发现 P1-NEW（严重）**：候选筛选 max_neighbors=16 对 80 fragment active 场景丢失 3/13 合并（23% 召回损失）
  - **发现测试弱化**：Codex 将 `test_candidate_filter_keeps_merge_outcome_on_active_case` 改为 `test_candidate_filter_active_case_reports_quality_tradeoff`，允许 ±5 容差掩盖召回损失
  - 实测 max_neighbors=48 可达零召回损失
  - 发现 P2-NEW-1~P2-NEW-4 共 4 个中优先级问题
  - 审查专利证据包脚本和权利要求 18-20
  - 综合评级 B，Stage 3 框架完整但候选筛选召回损失是红线
  - 撰写完整评审文档：`docs/review/r019_stage3_ann_hybrid_patent_review.md`
- Files Reviewed:
  - `src/memory_cluster/cluster.py` (655 行)
  - `src/memory_cluster/models.py`
  - `src/memory_cluster/pipeline.py`
  - `src/memory_cluster/cli.py`
  - `tests/test_merge_ann_candidates.py` (191 行)
  - `tests/test_merge_candidate_filter.py` (171 行)
  - `scripts/run_ann_hybrid_benchmark.py` (321 行)
  - `scripts/build_patent_evidence_pack.py` (365 行)
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/FINAL_REPORT.md`
- Files Changed:
  - `docs/review/r019_stage3_ann_hybrid_patent_review.md` (NEW)
  - `.claude.md` (追加 R-019 Opus 条目)
  - `WORK_PROGRESS.md` (追加 R-019 Opus 条目)
- Review Checklist:
  - [x] 51/51 测试通过
  - [x] P1-1 修复验证（签名不再退化）
  - [x] 召回损失量化实测（4 组 max_neighbors）
  - [x] ANN benchmark 数据解读
  - [x] 专利证据包 + 权利要求 18-20 审查
  - [x] 评审文档写入并含量化验证数据

## Entry — R-020 Opus 深度评审
- Timestamp: 2026-02-11 ~16:00 +08:00
- Stage: Stage 3 `_bucket_value` 替代方案 + 探索策略 深度评审
- Reviewer: Claude Opus 4.6
- Baseline: commit aa478f5 (main), 51/51 tests, `_bucket_value` + `_median` + exploratory neighbors
- Actions:
  - 审查 cluster.py (697 行) 核心变更：_bucket_value(3 维加权) + _median(中位数) + 探索策略(全局 top-48)
  - 运行 51/51 全量测试：通过
  - **发现 P0-1（最高）：`_bucket_value` 签名退化** — 唯一签名仅 25/240 (10.4%)，最大桶 96/240 (40%)，与 R-011 P1-1 同类缺陷
  - **发现 P1-1（高）：探索策略 O(k²)** — 实测 18.7% 负加速 (257ms vs 216.5ms)，桶划分不提供增量价值
  - **确认 P1-2（高）：ANN quality_gate_pass=false** — ann_prune merges=28 vs baseline=29，ANN 签名退化同源
  - 综合评级 B-
  - 撰写完整评审文档：`docs/review/r020_stage3_bucket_value_exploratory_review.md`
- Files Reviewed:
  - `src/memory_cluster/cluster.py` (697 行，重点 _bucket_value/_median/_build_candidate_neighbors/exploratory)
  - `tests/test_merge_candidate_filter.py` (171 行)
  - `tests/test_merge_ann_candidates.py` (191 行)
  - `scripts/run_ann_hybrid_benchmark.py` (321 行)
  - `scripts/build_patent_evidence_pack.py` (374 行)
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
- Files Changed:
  - `docs/review/r020_stage3_bucket_value_exploratory_review.md` (NEW — 完整评审含量化数据)
  - `.claude.md` (追加 R-020 Opus 条目)
  - `WORK_PROGRESS.md` (追加 R-020 Opus 条目)
- Review Checklist:
  - [x] 51/51 测试通过
  - [x] `_bucket_value` 签名多样性实测（240 条嵌入量化验证）
  - [x] 探索策略 O(k²) 开销量化（5 轮计时对比）
  - [x] ANN quality_gate_pass=false 根因分析
  - [x] benchmark 数据解读与交叉验证
  - [x] 评审文档写入并含量化验证数据

## Entry R-022
- Timestamp: 2026-02-11 13:02:45 +08:00
- Stage: Phase-2 收敛执行（核心主张聚焦 + 规模化实验 + 证据包重构）
- Actions:
  - 复跑并同步关键基准：
    - `outputs/candidate_filter_benchmark.json` / `docs/eval/candidate_filter_benchmark_report.md`
    - `outputs/ann_hybrid_benchmark.json` / `docs/eval/ann_hybrid_benchmark_report.md`
    - `outputs/prune_benchmark.json` / `docs/eval/prune_benchmark_report.md`
  - 新增核心规模化实验脚本 `scripts/run_core_scaling_benchmark.py`，完成：
    - realistic: `outputs/core_scaling_realistic.json` / `docs/eval/core_scaling_realistic_report.md`
    - stress: `outputs/core_scaling_stress.json` / `docs/eval/core_scaling_stress_report.md`
  - 重写 `scripts/build_patent_evidence_pack.py`，证据包改为“核心主张 + 可选实施例”结构。
  - 生成新版证据包：`outputs/patent_evidence_pack.json` 与 `docs/patent_kit/10_区别特征_技术效果_实验映射.md`。
  - 重写权利要求草案为收敛版：`docs/patent_kit/06_权利要求书_草案.md`（核心权利要求集中在 1、4-11）。
  - 重写阶段计划与总报告：
    - `docs/design/next_phase_plan.md`
    - `docs/FINAL_REPORT.md`
  - 代码清理：删除 `src/memory_cluster/cluster.py` 未使用 `_median` 死代码。
- Core Results:
  - 单测：`53/53` PASS
  - compileall：PASS
  - 核心规模化（N=1000）：
    - realistic: CEG `+2.29`, ARB `+36.1`
    - stress: CEG `+17.0`, ARB `+55.0`, DMG block `+735`
  - Candidate active: `merges_applied_equal=false`（21->20），`avg_speedup_ratio=-29.3320%`
  - ANN active: `quality_gate_pass=true` 但 `avg_speedup_ratio=-677.1452%`
- Decision:
  - 核心专利主线：CEG/ARB/DMG/语义精度
  - Candidate/ANN：降级为可选实施例，暂不作为核心独立主张
- Files Reviewed:
  - `src/memory_cluster/cluster.py`
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_ablation.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `scripts/run_prune_benchmark.py`
  - `scripts/build_patent_evidence_pack.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
- Files Changed:
  - `src/memory_cluster/cluster.py`
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_core_scaling_benchmark.py` (new)
  - `scripts/build_patent_evidence_pack.py` (rewritten)
  - `docs/FINAL_REPORT.md` (rewritten)
  - `docs/design/next_phase_plan.md` (rewritten)
  - `docs/patent_kit/06_权利要求书_草案.md` (rewritten)
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `docs/eval/core_scaling_realistic_report.md` (new)
  - `docs/eval/core_scaling_stress_report.md` (new)
  - `docs/eval/candidate_filter_benchmark_report.md`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/eval/prune_benchmark_report.md`
  - `WORK_PROGRESS.md`
  - `.claude.md`
- Review Checklist:
  - [x] 新增脚本通过编译检查
  - [x] 全量单测通过（53/53）
  - [x] compileall 通过
  - [x] 证据包可重建并与新权利要求结构一致
  - [x] FINAL_REPORT 与最新 JSON 指标一致
  - [x] 核心/可选实施例边界在文档中明确

## Entry R-021 (Opus)
- Timestamp: 2026-02-11 14:30:00 +08:00
- Stage: R-021 Opus 深度评审（P0-1 修复 + 规模化实验 + 专利收敛）
- Actions:
  - 逐段审查 cluster.py 760 行全量变更（_projection_score/中心化投影/探索移除）
  - 运行全量测试验证：53/53 PASS
  - 编写并执行独立签名质量验证脚本（tmp_r021_verify.py）
  - 审查核心规模化实验脚本（run_core_scaling_benchmark.py）及结果
  - 审查权利要求书草案收敛版（20→14 条）
  - 审查证据包重构（core_claim_ready/optional 分级）
  - 撰写 R-021 综合评审报告
- Key Findings:
  - P0-1 ANN 签名显著改善：25.4% 唯一率（原 10.4%）
  - P0-1 候选签名部分改善：17.1% 唯一率（仍低于 20% 质量门）
  - 探索策略 O(k²) 干净移除 ✓
  - ANN quality_gate 恢复 true（merges 29=29）✓
  - ANN 性能灾难：-677%（48 步投影过重）
  - 核心规模化实验为 CEG/ARB/DMG 提供首次千级正增益数据
  - 专利收敛 20→14 方向正确
- Rating: **B+**（较 R-020 B- 上升一级半）
- Files Reviewed:
  - `src/memory_cluster/cluster.py`（全量 760 行）
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_core_scaling_benchmark.py`
  - `scripts/build_patent_evidence_pack.py`
  - `docs/FINAL_REPORT.md`
  - `docs/eval/core_scaling_realistic_report.md`
  - `docs/eval/core_scaling_stress_report.md`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/patent_kit/06_权利要求书_草案.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `docs/review/r021_p0_fix_scaling_patent_convergence_review.md` (new)
  - `.claude.md`
  - `WORK_PROGRESS.md`
- Review Checklist:
  - [x] cluster.py 全量变更审查
  - [x] 53/53 测试通过验证
  - [x] 独立签名质量验证（覆盖候选 + ANN）
  - [x] 核心规模化实验数据审查
  - [x] 权利要求书收敛审查
  - [x] 证据包分级审查
  - [x] R-021 评审报告完成

## Entry R-023-Phase2-Deepen
- Timestamp: 2026-02-11 16:47:40 +08:00
- Stage: Phase-2 深化（算法防退化 + 半真实数据证据 + 全量自查）
- Actions:
  - 修复 `cluster.py`：新增候选/ANN 签名退化 fallback 门，新增 fallback 指标计数。
  - 修复 `cluster.py`：ANN 邻居刷新引入签名缓存，减少重复签名计算。
  - 收口默认参数：Candidate `steps=32,radius=3`，ANN `tables=4,bits=10,probe=1,steps=32`。
  - 修复并重写 `scripts/generate_semi_real_dataset.py`（乱码/可运行性/realistic+stress 双模式）。
  - 新增并运行半真实消融：`scripts/run_core_ablation_on_dataset.py`。
  - 重跑/更新 benchmark 与报告：candidate, ann_hybrid, core_scaling(realistic/stress), stage3_param_sweep。
  - 更新 `docs/FINAL_REPORT.md` 与 `docs/design/next_phase_plan.md`。
- Key Results:
  - 测试：`55/55` PASS（`python -m unittest discover -s tests -p "test_*.py"`）。
  - 编译：`python -m compileall -q src scripts tests` PASS。
  - Candidate benchmark（N=240）：
    - sparse: speedup `+20.8832%`, attempt reduction `70.8264%`。
    - active: speedup `-105.3205%`, merges `77 -> 76`（仍有有损风险）。
  - ANN benchmark（N=240）：
    - `ann_prune` active `quality_gate_pass=true`, speedup `-24.8820%`。
    - `hybrid_prune` active speedup `-144.7391%`。
  - Core scaling realistic（N=2000）：CEG `+2.29`, ARB `+36.0`。
  - Core scaling stress（N=1000）：CEG `+17.0`, ARB `+55.0`, DMG block `+735`。
  - Semi-real ablation realistic（N=2000）：CEG `+76.1`, ARB `+76.9`。
  - Semi-real ablation stress（N=2000）：CEG `+698.8`, ARB `+4.0`, DMG block `+12373`。
  - Stage3 sweep：Candidate 可达质量门但 active 仍负加速；ANN 未找到“质量+签名+正加速”三门同过组合。
- Decision:
  - 核心叙事继续聚焦 CEG/ARB/DMG/语义精度。
  - Candidate/ANN 维持“可选实施例（实验性）”，不进入核心授权论证主链。
- Review Checklist:
  - [x] 代码改动自查（关键路径：merge/gate/cache）
  - [x] 退化输入防线测试（candidate/ann fallback）
  - [x] 全量单测通过
  - [x] 编译检查通过
  - [x] 核心 benchmark 重跑
  - [x] 半真实数据实验重跑
  - [x] FINAL_REPORT 与 next_phase_plan 同步更新

## Entry R-024-Patent-Evidence-Alignment
- Timestamp: 2026-02-11 17:50:29 +08:00
- Stage: P0 文稿收口（权利要求-证据-命令一体化对齐）
- Actions:
  - 重写 `scripts/build_patent_evidence_pack.py`：
    - 接入最新证据源（含半真实数据与 stage3 参数扫描）；
    - 输出 `command_catalog`（命令ID统一索引）；
    - 增加自动一致性校验：claim refs / evidence files / metrics 完整性。
  - 重建证据包：
    - `outputs/patent_evidence_pack.json`
    - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
    - `docs/patent_kit/11_主张_证据_命令对照.md`（新增）
  - 更新文档：
    - `docs/patent_kit/06_权利要求书_草案.md`（新增答复优先级）
    - `docs/patent_kit/00_技术交底书_总览.md`（补 11 号文档索引）
    - `docs/FINAL_REPORT.md`（补证据包命令与 11 号文档入口）
- Key Results:
  - 证据包 `validation.passed=true`
  - `missing_claim_refs=[]`
  - `missing_evidence_files=[]`
  - `missing_metrics=[]`
  - claim 覆盖关系：06 文档含权利要求 1-14；证据包引用 1,4-14（与策略一致）
- Self-Check:
  - `python -m compileall -q src scripts tests` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (55/55)
  - `python scripts/build_patent_evidence_pack.py ...` PASS
- Review Checklist:
  - [x] 权利要求映射与证据ID一一对应
  - [x] 每个证据ID有可复现实验命令
  - [x] 核心/可选实施例边界明确
  - [x] 文档入口（00/10/11/FINAL_REPORT）一致

## Entry R-022 Opus
- Timestamp: 2026-02-11 18:30:00 +08:00
- Stage: R-022 Opus 深度评审（防退化 fallback + xorshift 优化 + 半真实数据 + 参数扫描 + 测试对齐）
- Reviewer: Claude Opus 4.6
- Baseline: 57/57 tests, R-023/R-024 Codex changes
- Actions:
  - 逐段审查 cluster.py 871 行全量变更（fallback/xorshift/签名缓存/参数调整）
  - 审查 models.py 默认参数变更
  - 审查新增测试（fallback + benchmark 对齐质量门）
  - 审查新增实验脚本（generate_semi_real_dataset / run_core_ablation_on_dataset / run_stage3_param_sweep）
  - 运行全量测试验证：57/57 PASS (3.304s)
  - 编写并执行独立签名质量验证脚本（tmp_r022_verify.py）
  - 审查 7 份实验报告与 FINAL_REPORT 数据一致性
  - 发现 cluster.py 与 models.py 间参数漂移问题
- Key Findings:
  - R-021 P1-1 修复有效：候选签名唯一率 10.8%→24.6%（steps 16→32）
  - R-021 P1-2 修复有效：ANN 性能 -677%→-24.9%（tables 6→4, steps 48→32, 签名缓存）
  - R-021 P1-3 修复有效：新增 2 个 benchmark 对齐测试
  - P1-NEW-1: 参数漂移 cluster.py vs models.py（ann_num_tables 4 vs 3, ann_max_neighbors 32 vs 48）
  - P1-NEW-2: Candidate active 仍有损（merges 77→76）
  - 半真实数据集为证据链显著增值（CEG +76.1/+698.8, DMG +12373）
- Rating: **A-**（较 R-021 B+ 上升半级）
- Files Reviewed:
  - `src/memory_cluster/cluster.py` (871 行全量)
  - `src/memory_cluster/models.py`
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/generate_semi_real_dataset.py`
  - `scripts/run_core_ablation_on_dataset.py`
  - `scripts/run_stage3_param_sweep.py`
  - `docs/FINAL_REPORT.md`
  - 7 份实验报告（candidate/ann/core_scaling/semi_real/stage3_sweep）
- Files Changed:
  - `docs/review/r022_semi_real_param_sweep_robustness_review.md` (NEW)
  - `.claude.md` (追加 R-022 Opus 条目)
  - `WORK_PROGRESS.md` (追加 R-022 Opus 条目)
- Review Checklist:
  - [x] 57/57 测试通过验证
  - [x] cluster.py 全量变更审查
  - [x] 独立签名质量验证（候选 + ANN 双对照）
  - [x] 实验报告数据交叉验证
  - [x] 参数漂移发现并记录
  - [x] R-022 Opus 评审报告完成

## Entry R-025-Algorithm-Scale-Evidence
- Timestamp: 2026-02-11 21:18:00 +08:00
- Stage: Stage-2 深化（候选/ANN 增量缓存优化 + 5000级半真实实验 + 文档收口）
- Actions:
  - 重构 `src/memory_cluster/cluster.py`：
    - 候选筛选与 ANN 邻接从“合并后全量重建”改为“增量更新”；
    - 引入 `_projection_plan` 缓存，减少重复 stride/start 计算；
    - 新增 state 结构（candidate/ann）并在合并后仅刷新受影响簇。
  - 参数与默认值收口：
    - `merge_candidate_signature_radius` 默认改为 `4`（优先等效性）；
    - ANN 默认改为 `num_tables=3`、`max_neighbors=48`（降低负加速风险）。
  - 基准脚本增强：
    - `scripts/run_candidate_filter_benchmark.py` 新增签名质量指标与质量门输出；
    - `scripts/run_ann_hybrid_benchmark.py` 新增 ANN 签名质量指标与门控输出。
  - 测试增强：
    - 新增 2 条 benchmark 同分布回归测试（candidate/ann 各 1）；
    - 全量测试由 55 增至 57。
  - 规模化实验推进：
    - 新增数据集：`data/examples/semi_real_memory_fragments_5000_realistic.jsonl`；
    - 新增数据集：`data/examples/semi_real_memory_fragments_5000_stress.jsonl`；
    - 运行 `core_ablation`（5000 realistic, 5 runs）与（5000 stress, 2 runs）；
    - realistic scaling 扩展到 `100,500,1000,2000,5000`。
  - 证据与报告同步：
    - 重写 `docs/FINAL_REPORT.md`（消除陈旧指标）；
    - 重写 `docs/design/next_phase_plan.md`（进入 R-025）；
    - 更新 `scripts/build_patent_evidence_pack.py` 对齐 5000 半真实证据；
    - 重建 `outputs/patent_evidence_pack.json`、`docs/patent_kit/10_*.md`、`docs/patent_kit/11_*.md`。
- Key Results:
  - 全量单测：`57/57 PASS`
  - compileall：PASS
  - Candidate benchmark（N=240, radius=4）：
    - sparse speedup `+0.173857`
    - active speedup `-0.135157`
    - `cluster_count_equal=true`, `merges_applied_equal=true`
  - Stage3 参数扫描：
    - Candidate 最优全门配置 `steps=32,radius=3,max_neighbors=48` 达到 active 正加速 `+0.018445`
    - ANN 仍未出现“质量门+签名门+正加速”三门同过配置
  - Semi-real 5000 realistic：CEG `+181.1`, ARB `+76.8`
  - Semi-real 5000 stress（runs=2）：CEG `+1748.8`, DMG block `+30746`
- Files Changed (high impact):
  - `src/memory_cluster/cluster.py`
  - `src/memory_cluster/models.py`
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `scripts/run_stage3_param_sweep.py`
  - `scripts/build_patent_evidence_pack.py`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `outputs/core_ablation_semi_real_5000_realistic.json`
  - `outputs/core_ablation_semi_real_5000_stress_runs2.json`
- Review Checklist:
  - [x] 算法改动后单测全通过
  - [x] 编译检查通过
  - [x] Candidate/ANN 基准重跑并记录
  - [x] Stage3 参数扫描重跑
  - [x] 5000级半真实实验完成并落盘
  - [x] 证据包校验 `validation.passed=true`
  - [x] FINAL_REPORT 与输出 JSON 指标对齐

## Entry R-023 Opus
- Timestamp: 2026-02-11 20:30:00 +08:00
- Stage: R-023 Opus 深度评审（参数漂移修复 + Candidate 等效性恢复 + N=5000 半真实 + 签名诊断）
- Reviewer: Claude Opus 4.6
- Baseline: 57/57 tests, R-025 Codex changes
- Actions:
  - 逐段审查 cluster.py 构造器参数对齐变更
  - 审查 models.py 参数确认
  - 审查 benchmark 脚本签名质量诊断增强
  - 审查测试 benchmark 同分布回归测试
  - 运行全量测试验证：57/57 PASS (3.723s)
  - 编写独立验证脚本 (tmp_r023_verify.py) 验证参数对齐和 Candidate 等效性
  - 编写 ANN 深度调查脚本 (tmp_r023_ann_check.py) 探查 fragment-level vs cluster-level 签名质量差异
  - 审查 5 组实验结果（candidate benchmark, ann benchmark, stage3 sweep, semi-real 5000 realistic/stress）
  - 审查 FINAL_REPORT.md 数据一致性
- Key Findings:
  - P1-NEW-1 (参数漂移): 修复确认（10/10 字段对齐）
  - P1-NEW-2 (Candidate 有损): 修复确认（merges 77=77, radius=4）
  - Stage3: Candidate 首次正加速 +1.8%（radius=3 全门通过）
  - ANN 签名诊断 vs 运行时行为不一致（fragment vs cluster centroid）
  - N=5000 半真实: CEG +181.1/+1748.8, DMG +30746
- Rating: **A**（项目迄今最强单轮交付）
- Files Reviewed:
  - `src/memory_cluster/cluster.py` (全量)
  - `src/memory_cluster/models.py`
  - `tests/test_merge_candidate_filter.py`
  - `tests/test_merge_ann_candidates.py`
  - `scripts/run_candidate_filter_benchmark.py`
  - `scripts/run_ann_hybrid_benchmark.py`
  - `scripts/run_stage3_param_sweep.py`
  - `docs/FINAL_REPORT.md`
  - 5 组实验 JSON 输出
- Files Changed:
  - `docs/review/r023_candidate_equiv_n5000_param_fix_review.md` (NEW)
  - `.claude.md` (追加 R-023 Opus 条目)
  - `WORK_PROGRESS.md` (追加 R-023 Opus 条目)
- Review Checklist:
  - [x] 57/57 测试通过验证
  - [x] 参数对齐独立验证（10 字段）
  - [x] Candidate 等效性独立验证（merges 77=77）
  - [x] ANN fallback 行为深度调查
  - [x] 实验数据交叉验证
  - [x] R-023 Opus 评审报告完成

## Entry R-026-ANN-Diagnostic-Alignment
- Timestamp: 2026-02-12 11:58:16 +08:00
- Stage: 阶段二收口（ANN 诊断口径对齐 + 文档决策固化 + 自查）
- Actions:
  - 修改 `scripts/run_ann_hybrid_benchmark.py`：
    - 新增 `cluster-entry-level` 签名诊断（与运行时 ANN fallback 同口径）；
    - 保留 `fragment-level` 诊断用于严格离线质量观察；
    - 输出 `signature_gate_pass_cluster_runtime / signature_gate_pass_cluster_strict / signature_gate_pass_fragment_strict`；
    - 将 `signature_gate_pass` 别名对齐为运行时门控结果，避免“报告失败但运行正常”的认知冲突。
  - 修改 `tests/test_merge_ann_candidates.py`：
    - 新增 `test_ann_cluster_entry_signature_quality_matches_runtime_gate`，锁定 cluster-entry 口径回归。
  - 重跑 ANN benchmark：
    - `outputs/ann_hybrid_benchmark.json`
    - `docs/eval/ann_hybrid_benchmark_report.md`
  - 更新文档：
    - `docs/FINAL_REPORT.md`
    - `docs/design/next_phase_plan.md`
  - 证据包对齐：
    - 更新 `scripts/build_patent_evidence_pack.py` 接入 Candidate 三档复验指标；
    - 重建 `outputs/patent_evidence_pack.json` 与 10/11 号专利对照文档。
  - 重建证据包并校验：
    - `outputs/patent_evidence_pack.json`
    - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
    - `docs/patent_kit/11_主张_证据_命令对照.md`
- Key Results:
  - 全量测试：`58/58 PASS`
  - ANN active（ann_prune）：
    - `quality_gate_pass=true`
    - `avg_speedup_ratio=-0.129717`
  - ANN 双口径签名结果：
    - fragment-level strict gate: `false`（min unique=0.1375）
    - cluster-entry runtime gate: `true`（min unique=0.212766, max bucket=0.510638）
  - 证据包校验：`validation.passed=true`, `missing_*=[]`
- Decision:
  - Candidate 继续采用“双档策略”：默认零损失档（发布）+ 高性能实验档（需复验）。
  - ANN 保持“可选实施例”，暂不进入核心授权主张。
- Review Checklist:
  - [x] ANN 诊断口径与运行门控对齐
  - [x] 新增 ANN 口径回归测试
  - [x] 全量测试通过（58/58）
  - [x] 关键 benchmark 重跑并落盘
  - [x] FINAL_REPORT 与 next_phase_plan 已同步
  - [x] 证据包已重建并通过校验

## Entry R-027-Candidate-3Scale-Validation
- Timestamp: 2026-02-12 14:00:13 +08:00
- Stage: P1 执行（Candidate 默认档 vs 实验档三档规模复验）
- Actions:
  - 新增脚本：`scripts/run_candidate_profile_validation.py`
    - 支持 `N=240/1000/5000` 多规模批量复验；
    - 对比默认档（radius=4）与实验档（radius=3）；
    - 输出质量门与速度门结论。
  - 运行三组验证：
    - `outputs/candidate_profile_validation_synthetic_active.json`（runs=2）
    - `outputs/candidate_profile_validation_realistic.json`（runs=2）
    - `outputs/candidate_profile_validation_stress.json`（runs=1）
  - 生成报告：
    - `docs/eval/candidate_profile_validation_synthetic_active_report.md`
    - `docs/eval/candidate_profile_validation_realistic_report.md`
    - `docs/eval/candidate_profile_validation_stress_report.md`
    - `docs/eval/candidate_profile_validation_summary.md`
  - 更新文档：
    - `docs/FINAL_REPORT.md`
    - `docs/design/next_phase_plan.md`
  - 清理临时排障产物（stress_n240/n1000/n5000 中间文件）
- Key Results:
  - synthetic_active（三档）：
    - 默认档：质量门全通过
    - 实验档：`N=240` 出现有损（`merges_applied 77 -> 76`）
  - semi_real_realistic（三档）：
    - 两档质量门均通过
    - 实验档最差速度 `-16.9310%`（N=5000）
  - semi_real_stress（三档, runs=1）：
    - 两档质量门通过，但 Candidate 全程 fallback（`merge_candidate_filter_fallbacks=1`，筛选未生效）
    - N=5000 运行成本高（单次三配置长时运行）
  - 综合建议：
    - 默认档继续固定 `radius=4`
    - `radius=3` 保留为实验参数，不升为默认
  - 证据包校验：`validation.passed=true`, `missing_*=[]`
- Self-Check:
  - `python -m compileall -q src scripts tests` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (58/58)
- Review Checklist:
  - [x] 三档规模复验已完成并落盘
  - [x] 关键反例（N=240 有损）已记录
  - [x] 文档与结果文件同步
  - [x] 回归测试与编译通过

## Entry R-024 Opus
- Timestamp: 2026-02-12 15:00:00 +08:00
- Stage: R-024 Opus 深度评审（ANN 诊断口径对齐 + 文档决策固化 + 证据包一致性）
- Reviewer: Claude Opus 4.6
- Baseline: 58/58 tests, R-026 Codex changes
- Actions:
  - 逐行审查 `scripts/run_ann_hybrid_benchmark.py` 新增双口径诊断函数
  - 逐行审查 `tests/test_merge_ann_candidates.py` 新增回归测试
  - 审查 FINAL_REPORT.md 双口径解释 + ANN 可选实施例定位
  - 审查 next_phase_plan.md R-026 计划
  - 交叉验证 ann_hybrid_benchmark.json 全部诊断字段
  - 交叉验证 patent_evidence_pack.json 一致性
  - 审查专利对照文档 (10/11 号)
  - 运行全量测试验证：58/58 PASS (6.787s)
  - 编写独立验证脚本 (tmp_r024_verify.py) 复现双口径诊断并做 9 项 JSON 一致性检查
- Key Findings:
  - P2-NEW-1 (ANN 诊断不一致): 已解决（三级门控 + 别名对齐）
  - 合并前质心数 = 94（R-023 误用合并后 18 → R-026 正确修正）
  - Cluster-entry: min_unique=0.2128, max_bucket=0.5106, runtime gate=true
  - JSON 一致性 9/9 OK
  - 证据包 validation.passed=true
  - 承继 P2: max_bucket=0.5106 仍高（ANN 负加速根因）
- Rating: **A-**（高质量聚焦修复）
- Files Reviewed:
  - `scripts/run_ann_hybrid_benchmark.py` (全量)
  - `tests/test_merge_ann_candidates.py` (全量)
  - `outputs/ann_hybrid_benchmark.json`
  - `docs/eval/ann_hybrid_benchmark_report.md`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
  - `outputs/patent_evidence_pack.json`
  - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
  - `docs/patent_kit/11_主张_证据_命令对照.md`
  - `WORK_PROGRESS.md`
  - `.claude.md`
- Files Changed:
  - `docs/review/r024_ann_diagnostic_alignment_review.md` (NEW)
  - `.claude.md` (追加 R-024 Opus 条目)
  - `WORK_PROGRESS.md` (追加 R-024 Opus 条目)
- Review Checklist:
  - [x] 58/58 测试通过验证
  - [x] 双口径诊断独立复现
  - [x] JSON 一致性 9/9 全通过
  - [x] 证据包交叉验证
  - [x] 文档一致性确认
  - [x] R-024 Opus 评审报告完成

## Entry R-028-Stage2-Guardrail-And-UnitTests
- Timestamp: 2026-02-12 20:15:35 +08:00
- Stage: 阶段二工程稳健性推进（回归门禁自动化 + 细粒度单测补齐）
- Actions:
  - 新增 `scripts/run_stage2_guardrail.py`：聚合 Candidate profile/benchmark + ANN benchmark 的发布门禁检查。
  - 新增 `tests/test_stage2_guardrail.py`：门禁脚本逻辑单测（通过、阻塞失败、strict 模式）。
  - 新增 `tests/test_embed_eval_unit.py`：`embed.py` / `eval.py` 细粒度行为测试。
  - 增强 `tests/test_store_reliability.py`：同批次幂等去重与 `load_latest_by_id_with_stats` 统计回传测试。
  - 生成门禁结果与报告：
    - `outputs/stage2_guardrail.json`
    - `docs/eval/stage2_guardrail_report.md`
  - 更新专利证据构建：`scripts/build_patent_evidence_pack.py`
    - 新增 `CMD_STAGE2_GUARDRAIL`
    - DF-06 接入 stage2 guardrail 指标与证据文件。
  - 重建证据包：
    - `outputs/patent_evidence_pack.json`
    - `docs/patent_kit/10_区别特征_技术效果_实验映射.md`
    - `docs/patent_kit/11_主张_证据_命令对照.md`
- Key Results:
  - `python -m unittest discover -s tests -p "test_*.py"`: `68/68 PASS`
  - `python -m compileall -q src scripts tests`: PASS
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md`: PASS
    - `summary.passed=true`
    - `blocker_failures=0`
    - `known_limitations.fast_profile_loss_at_synthetic_n240=true`（默认模式为非阻塞）
  - 证据包校验：`validation.passed=true`, `missing_*=[]`
- Review Checklist:
  - [x] 回归门禁脚本可执行并输出非空指标
  - [x] 门禁阻塞项与已知限制分级明确
  - [x] 新增单测覆盖 embed/eval/store/guardrail
  - [x] 全量单测通过（68/68）
  - [x] 证据包已重建并通过校验

## Entry R-025 Opus
- Timestamp: 2026-02-12 20:45:00 +08:00
- Stage: R-025 Opus 深度评审（Stage-2 门禁 + 细粒度测试 + 证据链升级）
- Reviewer: Claude Opus 4.6
- Baseline: 68/68 tests, R-028 Codex changes
- Actions:
  - 逐行审查 run_stage2_guardrail.py（253 行新增，9 项门禁检查）
  - 逐行审查 test_stage2_guardrail.py（3 场景测试）
  - 逐行审查 test_embed_eval_unit.py（5 项嵌入/评估单测）
  - 逐行审查 test_store_reliability.py（8 项存储可靠性测试）
  - 审查 build_patent_evidence_pack.py DF-06 + CMD 变更
  - 审查 FINAL_REPORT.md R-028 Delta
  - 审查 next_phase_plan.md R-028 Plan Update
  - 交叉验证 stage2_guardrail.json + patent_evidence_pack.json
  - 运行全量测试验证：68/68 PASS (4.101s)
  - 独立运行门禁默认模式：passed=true, 9/9
  - 独立运行门禁严格模式：passed=false, exit=2, blocker=fast_n240_known_loss
- Key Findings:
  - 门禁设计: blocker/warning 分级 + allow_known_fast_loss 可切换
  - 测试覆盖: +10 (58→68)，embed/eval/store/guardrail 长期盲区补齐
  - 证据链: CMD_STAGE2_GUARDRAIL 已入目录，DF-06 guardrail metrics 齐全
  - P3-1 承继: DF-06 technical_effect "candidate 仍有有损风险" 未修正
  - P3-4: FINAL_REPORT 测试数 58/58 滞后（实际 68/68）
  - P3-2 新: 门禁缺速度回归告警
- Rating: **A-**（工程价值高，文档细节仍有滞后）
- Files Reviewed:
  - `scripts/run_stage2_guardrail.py` (全量)
  - `tests/test_stage2_guardrail.py` (全量)
  - `tests/test_embed_eval_unit.py` (全量)
  - `tests/test_store_reliability.py` (全量)
  - `scripts/build_patent_evidence_pack.py` (全量)
  - `outputs/stage2_guardrail.json`
  - `docs/eval/stage2_guardrail_report.md`
  - `outputs/patent_evidence_pack.json`
  - `docs/FINAL_REPORT.md`
  - `docs/design/next_phase_plan.md`
- Files Changed:
  - `docs/review/r025_stage2_guardrail_engineering_review.md` (NEW)
  - `.claude.md` (追加 R-025 Opus 条目)
  - `WORK_PROGRESS.md` (追加 R-025 Opus 条目)
- Review Checklist:
  - [x] 68/68 测试通过验证
  - [x] 门禁默认 + 严格双模式独立验证
  - [x] 证据包交叉验证
  - [x] 文档一致性审查
  - [x] R-025 Opus 评审报告完成

## Entry R-029-Guardrail-SpeedWarning-And-Freeze
- Timestamp: 2026-02-13 01:02:24 +08:00
- Stage: R-025 评审意见落实（报告修正 + DF-06 口径修正 + 速度告警 + ANN 冻结决策）
- Actions:
  - 更新 `scripts/run_stage2_guardrail.py`：新增速度告警检查
    - `ann_active_speed_regression_warn`
    - `ann_active_positive_speed_target_warn`
    - `candidate_active_speed_regression_warn`
  - 新增参数：
    - `--candidate-active-speed-warn-floor`
    - `--ann-active-speed-warn-floor`
  - 扩展门禁输出 `known_limitations`：
    - `ann_active_not_positive_speedup`
    - `candidate_active_speed`
    - `ann_active_speed`
  - 更新 `tests/test_stage2_guardrail.py`：补 `candidate_benchmark=None` 路径。
  - 更新 `scripts/build_patent_evidence_pack.py`：
    - DF-06 technical_effect 修正为“默认 Candidate 零损失 + 实验档风险披露”；
    - 接入新增 guardrail 速度指标。
  - 文档修正：
    - `docs/FINAL_REPORT.md` 测试数修正至 `69/69`；
    - 追加 R-029 冻结决策说明（ANN 仍无正加速，保持可选实施例）；
    - `docs/design/next_phase_plan.md` 追加 R-029 计划更新。
  - 清理临时文件：删除 `tmp_r022_verify.py`、`tmp_r023_ann_check.py`、`tmp_r023_verify.py`、`tmp_r024_verify.py`。
- Key Results:
  - `python -m unittest discover -s tests -p "test_*.py"`: `69/69 PASS`
  - `python -m compileall -q src scripts tests`: PASS
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md`: PASS
    - `summary.passed=true`
    - `blocker_failures=0`
    - `warning_failures=1`（ANN active 速度未转正）
  - `python scripts/build_patent_evidence_pack.py ...`: PASS
    - `validation.passed=true`, `missing_*=[]`
- Review Checklist:
  - [x] FINAL_REPORT 测试数已修正
  - [x] DF-06 技术效果口径已修正
  - [x] 门禁已增加速度告警
  - [x] ANN 冻结决策已文档化
  - [x] `candidate_benchmark=None` 测试已补
  - [x] 全量测试与编译通过

## Entry R-030-CI-Stage2-Quality-Gate
- Timestamp: 2026-02-13 10:48:56 +08:00
- Stage: 下一步执行（Stage-2 门禁接入 CI）
- Actions:
  - 新增 CI 编排脚本：`scripts/run_ci_guardrail_bundle.py`
    - 轻量流水线：生成 semi-real 数据（realistic/stress）→ Candidate benchmark → Candidate profile validation（三组）→ ANN benchmark → Stage-2 guardrail。
    - 默认参数：`dataset-size=240`, `benchmark-fragment-count=120`, `runs=1`, `warmup-runs=0`。
    - 输出报告统一落盘到 `outputs/ci_reports/`，避免覆盖仓库内已跟踪评估文档。
  - 新增 GitHub Actions 工作流：`.github/workflows/stage2-quality-gate.yml`
    - 触发：`pull_request`, `push(main)`, `workflow_dispatch`
    - 门禁：`compileall + unittest + run_ci_guardrail_bundle`
    - 产物上传：`stage2_guardrail.json` 与相关 benchmark JSON/报告。
  - 更新 README：新增 Stage-2 CI 门禁本地复现命令与输出说明。
- Verification:
  - `python scripts/run_ci_guardrail_bundle.py --dataset-size 240 --benchmark-fragment-count 120 --runs 1 --warmup-runs 0` PASS
    - `outputs/stage2_guardrail.json`: `passed=true`, `blocker_failures=0`, `warning_failures=1`
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`69/69`)
  - `python -m compileall -q src scripts tests` PASS
- Review Checklist:
  - [x] CI workflow 文件创建并可读
  - [x] 本地复现命令可跑通
  - [x] blocker 门禁可阻断（由 guardrail 退出码控制）
  - [x] 报告输出不污染已跟踪评估报告
  - [x] 全量单测通过

## Entry R-030b-CI-Bundle-Decoupling-And-Test
- Timestamp: 2026-02-13 10:51:24 +08:00
- Stage: CI 门禁脚本稳健化（去外部依赖 + 单测补齐）
- Actions:
  - 更新 `scripts/run_ci_guardrail_bundle.py`：内置 semi-real 数据集生成，不再依赖 `scripts/generate_semi_real_dataset.py` 外部脚本。
  - CI 报告输出路径统一为 `outputs/ci_reports/`。
  - 新增 `tests/test_ci_guardrail_bundle_unit.py`：验证数据集生成 JSONL 结构与最小样本约束。
  - 更新 `docs/FINAL_REPORT.md` 当前测试数到 `71/71`。
- Verification:
  - `python scripts/run_ci_guardrail_bundle.py --dataset-size 240 --benchmark-fragment-count 120 --runs 1 --warmup-runs 0` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`71/71`)
  - `python -m compileall -q src scripts tests` PASS
- Review Checklist:
  - [x] CI bundle 脚本不依赖未纳管外部脚本
  - [x] 新增单测覆盖 CI bundle 关键逻辑
  - [x] 全量测试通过（71/71）

## Entry R-031-Nightly-Trend-Pipeline
- Timestamp: 2026-02-13 11:44:50 +08:00
- Stage: 下一步执行（夜间趋势追踪与告警稳定性）
- Actions:
  - 新增 `scripts/update_guardrail_trend.py`：将 `stage2_guardrail.json` 追加到趋势文件，计算 pass/blocker/warning 比率与速度均值。
  - 新增 `tests/test_guardrail_trend_unit.py`：趋势记录抽取、保留窗口、roundtrip 测试。
  - 新增 `.github/workflows/stage2-nightly-trend.yml`：定时/手动运行 nightly profile（runs=3,warmup=1）并产出 `stage2_guardrail_trend.json`。
  - 更新 `README.md`：新增 Stage-2 Nightly 趋势说明与本地复现命令。
- Verification:
  - `python -m unittest tests.test_guardrail_trend_unit tests.test_ci_guardrail_bundle_unit` PASS (5 tests)
  - `python scripts/update_guardrail_trend.py --input outputs/stage2_guardrail.json --output outputs/stage2_guardrail_trend.json --label local --retain 90` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`74/74`)
  - `python -m compileall -q src scripts tests` PASS
- Review Checklist:
  - [x] 夜间趋势 workflow 创建并可读
  - [x] 趋势脚本可追加并输出聚合指标
  - [x] 趋势单测覆盖关键路径
  - [x] 全量测试通过（74/74）

## Entry R-032-Release-Gate-Workflow
- Timestamp: 2026-02-13 12:05:13 +08:00
- Stage: 下一步执行（发版前强制 Stage-2 质量门禁）
- Actions:
  - 新增 `.github/workflows/release-with-stage2-gate.yml`（`workflow_dispatch`）:
    - 解析目标 SHA（默认 `origin/main`）
    - 调用 `scripts/check_stage2_gate_for_sha.py` 校验 `stage2-quality-gate` 成功记录（168h 窗口）
    - 仅通过后才创建并推送 tag，再创建 GitHub Release
  - 新增 `tests/test_check_stage2_gate_for_sha_unit.py`：
    - 覆盖 ISO 时间解析、成功运行选择、过期失败、URL 编码
  - 更新 `README.md`：补充 Release 门禁说明与本地复现实验命令
  - 更新 `docs/FINAL_REPORT.md` 与 `docs/design/next_phase_plan.md`：追加 R-032 Delta/Plan
- Verification:
  - `python -m unittest tests.test_check_stage2_gate_for_sha_unit -v` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`79/79`)
  - `python -m compileall -q src scripts tests` PASS
- Review Checklist:
  - [x] release workflow 添加且逻辑可读
  - [x] gate checker 单测覆盖关键分支
  - [x] 文档与计划已同步
  - [x] 全量测试与编译通过

## Entry R-026 Opus + Workflow Spec
- Timestamp: 2026-02-13 11:30:00 +08:00
- Stage: R-026 Opus 评审（R-029 速度门禁 + R-030/R-030b CI 集成）+ 工作规范体系升级
- Reviewer: Claude Opus 4.6
- Baseline: 71/71 tests (R-030b), 74/74 tests (R-031)
- Actions:
  - 评审 R-029 + R-030 + R-030b 三轮合并变更
  - 独立验证: 71/71 tests PASS, 门禁 passed=true (12 checks, warning=1), 证据包 validation.passed=true
  - 发现 P1-1: CI bundle 覆写全量 benchmark 输出（stage2_guardrail.json/report.md 时间戳不一致）
  - 评级: **A-**（八轮高位稳定，遗留 6/6 全部处理）
  - 工作规范体系升级:
    - 新建 `CLAUDE.md`：项目级强制规范（输出路径隔离、参数一致性、技术决策锁定）
    - 重写 `AGENTS.md`：补充 Quality Gate、Output Path Rules、Locked Decisions、Known Limitations
    - 升级 `docs/REVIEW_CHECKLIST.md` → v2.0：9 类检查项（P0~P3 分级）
    - 更新 `.claude.md`：新增 Mandatory Self-Check、Cross-Reference、改进 Handover Essentials
    - 新建 `docs/design/codex_execution_prompt.md`：Codex 标准执行提示词
- Key Findings (R-026 Opus):
  - R-025 Opus 遗留 6/6 全部修复（100% 达标率）
  - 速度门禁: 3 项 speed warning 正确实现
  - CI 集成: workflow + self-contained bundle 功能完整
  - P1-1: CI bundle 输出路径需隔离（覆写全量数据风险）
  - P2-1: 报告/JSON 时间戳不一致（P1-1 直接后果）
- Files Changed:
  - `docs/review/r026_r029_r030_speed_ci_integration_review.md` (NEW — 评审报告)
  - `CLAUDE.md` (NEW — 项目级规范)
  - `AGENTS.md` (REWRITE — Agent 规范升级)
  - `docs/REVIEW_CHECKLIST.md` (REWRITE — v1.1 → v2.0)
  - `.claude.md` (UPDATE — 工作流 + R-026 Opus 条目)
  - `docs/design/codex_execution_prompt.md` (NEW — Codex 提示词)
  - `WORK_PROGRESS.md` (追加本条目)
- Review Checklist:
  - [x] R-029/R-030/R-030b 全量代码审查
  - [x] 独立测试验证 (71/71 → 74/74)
  - [x] 门禁默认 + 严格双模式验证
  - [x] 证据包一致性验证
  - [x] R-026 Opus 评审报告完成
  - [x] 工作规范体系 5 文件升级完成

## Entry R-033-CI-Output-Isolation
- Timestamp: 2026-02-13 12:28:24 +08:00
- Stage: R-026 遗留 P1 收敛（CI 输出路径隔离）
- Actions:
  - 重构 `scripts/run_ci_guardrail_bundle.py`：
    - 新增 `_build_bundle_commands()`，统一命令编排；
    - Candidate/ANN/Guardrail JSON 输出全部改为 `outputs/ci_outputs/*.json`；
    - CI guardrail 显式读取 `--candidate-*`、`--ann-hybrid`、`--candidate-benchmark` 的 `ci_outputs` 路径。
  - 更新 workflow：
    - `.github/workflows/stage2-quality-gate.yml` artifact JSON 路径切换至 `outputs/ci_outputs/`；
    - `.github/workflows/stage2-nightly-trend.yml` 趋势输入切换至 `outputs/ci_outputs/stage2_guardrail.json`。
  - 增强测试：
    - `tests/test_ci_guardrail_bundle_unit.py` 新增路径隔离断言，防止回归写回 `outputs/` 根目录。
  - 更新文档：
    - `README.md` 本地复现命令与输出路径同步；
    - `docs/FINAL_REPORT.md` 追加 R-033 Delta，并更新测试计数；
    - `docs/design/next_phase_plan.md` 追加 R-033 Plan Update。
- Verification:
  - `python -m unittest tests.test_ci_guardrail_bundle_unit tests.test_stage2_guardrail tests.test_check_stage2_gate_for_sha_unit -v` PASS
  - `python scripts/run_ci_guardrail_bundle.py --dataset-size 240 --benchmark-fragment-count 120 --runs 1 --warmup-runs 0` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`80/80`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] CI JSON 输出与权威输出隔离完成
  - [x] stage2-quality-gate artifact 路径同步
  - [x] nightly trend 输入路径同步
  - [x] 路径隔离单测新增并通过
  - [x] 全量测试、编译、门禁、证据包自查通过

## Entry R-034-CI-Output-Policy-Guard
- Timestamp: 2026-02-13 12:38:09 +08:00
- Stage: 下一轮推进（CI 输出路径策略自动门禁）
- Actions:
  - 新增 `scripts/check_ci_output_isolation.py`：
    - 校验 `run_ci_guardrail_bundle` 命令构建是否仅输出到 `outputs/ci_outputs/*.json`；
    - 校验 workflow 是否引用禁用路径（`outputs/*.json` 根目录）；
    - 输出 `outputs/ci_outputs/output_isolation_check.json`，违规时退出码 `2`。
  - 新增 `tests/test_ci_output_isolation_unit.py`：
    - 覆盖 bundle 命令通过/失败分支；
    - 覆盖 workflow 文本通过/失败分支。
  - 更新 workflow：
    - `.github/workflows/stage2-quality-gate.yml` 增加 `Validate CI Output Isolation` 步骤并上传检查产物；
    - `.github/workflows/stage2-nightly-trend.yml` 同步增加检查步骤与产物上传。
  - 更新文档：
    - `README.md` 新增本地执行路径隔离检查命令；
    - `docs/FINAL_REPORT.md` 追加 R-034 Delta；
    - `docs/design/next_phase_plan.md` 追加 R-034 Plan Update。
- Verification:
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS
  - `python -m unittest tests.test_ci_output_isolation_unit tests.test_ci_guardrail_bundle_unit -v` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`84/84`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] 新增 CI 输出隔离策略检查脚本
  - [x] 新增策略脚本单测并覆盖正反分支
  - [x] 两个 CI workflow 均接入策略检查
  - [x] 产物可追溯（`output_isolation_check.json`）
  - [x] 全量自查通过

## Entry R-035-Checklist-Gate-Hardening
- Timestamp: 2026-02-13 12:56:14 +08:00
- Stage: 下一轮推进（评审清单门禁条款升级）
- Actions:
  - 升级 `docs/REVIEW_CHECKLIST.md` 至 `v2.1`：
    - 将 CI 输出隔离明确为 P1 强制门禁；
    - 增加自动校验绑定条款（`check_ci_output_isolation.py` 的 `passed=true` 与 `violation_count=0`）；
    - 增加 workflow 约束条款（两条 CI workflow 必须包含 `Validate CI Output Isolation`）。
  - 更新 `docs/design/next_phase_plan.md`：追加 R-035 Plan Update。
  - 更新 `docs/FINAL_REPORT.md`：追加 R-035 Delta。
  - 更新 `.claude.md`：追加 R-035 评审条目与自查结论。
- Verification:
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS
  - `python -m compileall -q src scripts tests` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`84/84`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] 清单版本升级并保持结构一致
  - [x] P1 门禁条款具备可执行判定标准
  - [x] 自动化检查脚本与清单条款已对齐
  - [x] 计划/报告/进度日志同步完成
  - [x] 全量自查通过

## Entry R-036-R027-Followup-Cleanup
- Timestamp: 2026-02-13 13:17:06 +08:00
- Stage: 下一轮推进（按 R-027 评审收敛文档遗留）
- Actions:
  - 修复 `FINAL_REPORT.md`：
    - R-delta 顺序改为时间/编号一致（R-031 → R-032 → R-033 → R-034 → R-035）；
    - R-031 历史测试快照修正为 `74/74`。
  - 修复 `WORK_PROGRESS.md`：
    - R-032 verification 行补全全量测试计数为 `79/79`。
  - 同步 `docs/design/next_phase_plan.md` 与 `docs/FINAL_REPORT.md`，追加 R-036 更新条目。
  - 同步 `.claude.md`，记录 R-036 自查结论。
- Verification:
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS
  - `python -m compileall -q src scripts tests` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`84/84`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] R-delta 顺序恢复为可审计时间序
  - [x] R-031 测试计数历史快照修正
  - [x] R-032 verification 全量测试计数补齐
  - [x] 报告/计划/进度日志同步完成
  - [x] 全量自查通过

## Entry R-037-Review-Closure-Matrix
- Timestamp: 2026-02-13 13:21:39 +08:00
- Stage: 下一轮推进（评审闭环矩阵落地）
- Actions:
  - 新增 `docs/review/review_closure_matrix.md`：
    - 建立 finding 级闭环看板（ID/级别/状态/修复轮次/证据）；
    - 首批映射 R-027 关键结论（P2-1/P2-2/P3-2）；
    - 纳入承继问题 R-026 P1-1 的闭环链（R-033~R-035）；
    - 单列 `Accepted Limitations`（ANN active speed / candidate fast profile）。
  - 更新 `docs/FINAL_REPORT.md`：追加 R-037 Delta（闭环矩阵接入）。
  - 更新 `docs/design/next_phase_plan.md`：追加 R-037 Plan Update。
  - 更新 `.claude.md`：追加 R-037 条目与自查结果。
- Verification:
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS
  - `python -m compileall -q src scripts tests` PASS
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`84/84`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] 闭环矩阵文档创建并可独立阅读
  - [x] R-027 finding 映射完整且状态明确
  - [x] 闭环证据路径可追溯
  - [x] 报告/计划/进度日志同步完成
  - [x] 全量自查通过

## Entry R-038-Review-Matrix-Automation
- Timestamp: 2026-02-13 14:35:26 +08:00
- Stage: 下一轮推进（评审闭环矩阵自动化与单测补全）
- Actions:
  - 强化 `scripts/append_review_closure_round.py`：
    - 新增 `validate_round_id()`，限制轮次格式为 `R-XXX` / `R-XXXX`（可带后缀）；
    - 修复锚点定位逻辑，支持 `## Accepted Limitations (Non-blocking)` 这类带后缀标题；
    - 保留重复轮次阻断（重复 section 直接返回错误）。
  - 新增 `tests/test_review_closure_matrix_unit.py`（5 tests）：
    - 插入位置正确（新轮次应在 Accepted Limitations 之前）；
    - 重复轮次拒绝；
    - 无锚点时回退到文末追加；
    - 轮次格式校验通过/失败路径。
  - 更新文档：
    - `README.md` 增加闭环矩阵模板追加命令；
    - `docs/review/review_closure_matrix.md` 升级到 `v1.1` 并补充模板命令。
- Verification:
  - `python -m unittest tests.test_review_closure_matrix_unit -v` PASS (`5/5`)
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`89/89`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS (`passed=true`, `violation_count=0`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] 闭环矩阵脚本关键分支补齐单测
  - [x] 锚点匹配兼容带后缀标题
  - [x] 轮次编号输入校验已加固
  - [x] 文档命令入口同步完成
  - [x] 全量自查通过

## Entry R-039-Core-Claim-Stability
- Timestamp: 2026-02-13 18:38:59 +08:00
- Stage: 下一轮推进（核心算法证据加厚 + 评审流程治理升级）
- Actions:
  - 新增 `scripts/run_core_claim_stability.py`：
    - 对 CEG/ARB/DMG 进行重复运行统计；
    - 输出 mean/std/ci95/p05/p50/p95/positive_rate；
    - 产出稳定性门控（`ci95 lower > 0`）。
  - 新增 `tests/test_core_claim_stability_unit.py`（4 tests）：
    - 常量分布、空输入、单值 CI、正收益比例。
  - 执行半真实数据稳定性实验：
    - realistic-2000：`runs=12`；
    - stress-2000：`runs=4`（原 `runs=12` 超时后分批降载）。
  - 升级评审治理：
    - `docs/REVIEW_CHECKLIST.md` `v2.1 -> v2.2`；
    - `docs/review/review_closure_matrix.md` `v1.1 -> v1.2`；
    - 新增 `closed_by_reviewer` 状态并记录 R-028 reviewer-direct-fix。
  - 文档同步：
    - `docs/FINAL_REPORT.md` 追加 R-039 Delta；
    - `docs/design/next_phase_plan.md` 追加 R-039 Plan Update；
    - `README.md` 追加稳定性实验命令。
- Verification:
  - `python -m unittest tests.test_core_claim_stability_unit -v` PASS (`4/4`)
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`93/93`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/run_core_claim_stability.py --input data/examples/semi_real_memory_fragments_2000_realistic.jsonl --dataset-label semi_real_2000_realistic --output outputs/core_claim_stability_semi_real_2000_realistic.json --report docs/eval/core_claim_stability_semi_real_2000_realistic_report.md --runs 12 --warmup-runs 2 --similarity-threshold 0.68 --merge-threshold 0.82` PASS
  - `python scripts/run_core_claim_stability.py --input data/examples/semi_real_memory_fragments_2000_stress.jsonl --dataset-label semi_real_2000_stress --output outputs/core_claim_stability_semi_real_2000_stress.json --report docs/eval/core_claim_stability_semi_real_2000_stress_report.md --runs 4 --warmup-runs 1 --similarity-threshold 1.1 --merge-threshold 0.05` PASS
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS (`passed=true`, `violation_count=0`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] 核心主张稳定性统计脚本落地
  - [x] 新脚本单测覆盖关键统计分支
  - [x] 半真实 realistic/stress 双场景已产出报告
  - [x] 评审矩阵强制附件规则已入清单
  - [x] 全量自查通过

## Entry R-040-Core-Stability-5000-Batched
- Timestamp: 2026-02-13 21:45:17 +08:00
- Stage: 下一轮推进（5000 规模稳定性证据 + 分批续跑工程化）
- Actions:
  - 升级 `scripts/run_core_claim_stability.py`：
    - 增加分批续跑参数 `--checkpoint` / `--resume` / `--max-new-runs`；
    - 增加 DMG 激活指标：`dmg_guard_activation_rate`、`dmg_mixed_mode_reduction_rate`、`baseline_mixed_mode_presence_rate`、`dmg_effective_profile`；
    - 报告新增执行状态字段：`runs_completed`、`is_complete`。
  - 执行 5000 规模实验：
    - realistic: `runs=6` 一次性完成；
    - stress: `runs=3` 通过 batch1 + resume 两步完成（长耗时场景可复现）。
  - 升级证据链：
    - `scripts/build_patent_evidence_pack.py` command catalog 新增 5000 规模 stability 命令。
  - 评审闭环矩阵更新：
    - `docs/review/review_closure_matrix.md` 升级至 `v1.3`；
    - R-028 `P3-NEW-2`（reviewer-direct-fix 追踪建议）标记为闭环完成。
- Verification:
  - `python -m unittest tests.test_core_claim_stability_unit -v` PASS (`6/6`)
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`95/95`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/run_core_claim_stability.py --input data/examples/semi_real_memory_fragments_5000_realistic.jsonl --dataset-label semi_real_5000_realistic --output outputs/core_claim_stability_semi_real_5000_realistic.json --report docs/eval/core_claim_stability_semi_real_5000_realistic_report.md --runs 6 --warmup-runs 1 --similarity-threshold 0.68 --merge-threshold 0.82 --checkpoint outputs/core_claim_stability_semi_real_5000_realistic_checkpoint.json` PASS (`runs_completed=6`, `is_complete=true`)
  - `python scripts/run_core_claim_stability.py --input data/examples/semi_real_memory_fragments_5000_stress.jsonl --dataset-label semi_real_5000_stress --output outputs/core_claim_stability_semi_real_5000_stress.json --report docs/eval/core_claim_stability_semi_real_5000_stress_report.md --runs 3 --max-new-runs 1 --warmup-runs 0 --similarity-threshold 1.1 --merge-threshold 0.05 --checkpoint outputs/core_claim_stability_semi_real_5000_stress_checkpoint.json` PASS (batch1)
  - `python scripts/run_core_claim_stability.py --input data/examples/semi_real_memory_fragments_5000_stress.jsonl --dataset-label semi_real_5000_stress --output outputs/core_claim_stability_semi_real_5000_stress.json --report docs/eval/core_claim_stability_semi_real_5000_stress_report.md --runs 3 --max-new-runs 2 --warmup-runs 0 --similarity-threshold 1.1 --merge-threshold 0.05 --checkpoint outputs/core_claim_stability_semi_real_5000_stress_checkpoint.json --resume` PASS (`runs_completed=3`, `is_complete=true`)
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS (`passed=true`, `violation_count=0`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md` PASS (`passed=true`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] 5000 realistic/stress 稳定性实验可复现
  - [x] stress 长耗时场景支持 checkpoint 续跑
  - [x] DMG 激活度指标加入统计与报告
  - [x] 证据命令目录同步新增 5000 稳定性命令
  - [x] 全量自查通过

## Entry R-041-Guardrail-CoreStability-ResumeSmoke
- Timestamp: 2026-02-14 01:35:00 +08:00
- Stage: 下一轮推进（Stage-2 完整性门禁 + resume 失配烟雾测试）
- Actions:
  - 升级 `scripts/run_stage2_guardrail.py`：
    - 新增可重复参数 `--core-stability <path>`；
    - 对指定稳定性结果新增 blocker 级完整性检查（`is_complete=true`）；
    - 输出新增 `core_stability` 汇总（`profile_count`、`incomplete_count`、profile 列表）。
  - 增加测试覆盖：
    - `tests/test_stage2_guardrail.py` 新增 2 个用例（core-stability pass/fail）。
    - 新增 `tests/test_core_claim_stability_resume_smoke.py`（CLI 烟雾测试：`--resume` 签名失配必须失败）。
  - 文档与证据链同步：
    - `README.md` 增加带 core-stability 的门禁命令。
    - `scripts/build_patent_evidence_pack.py` 的 `CMD_STAGE2_GUARDRAIL` 同步加上 core-stability 输入；
    - DF-06 增加 `stage2_guardrail_core_stability_profile_count` 与 `stage2_guardrail_core_stability_incomplete_count`。
    - 新增外部评审摘要：`docs/review/r041_core_stability_guardrail_resume_smoke_summary.md`（含 5000-stress 运行成本与分批理由）。
- Verification:
  - `python -m unittest tests.test_stage2_guardrail tests.test_core_claim_stability_resume_smoke -v` PASS (`7/7`)
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`98/98`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md --core-stability outputs/core_claim_stability_semi_real_5000_realistic.json --core-stability outputs/core_claim_stability_semi_real_5000_stress.json` PASS (`check_count=14`, `blocker_failures=0`, `warning_failures=1`)
- Review Checklist:
  - [x] Stage-2 可选 core-stability 完整性门禁落地
  - [x] `--resume` 签名失配路径存在可复现烟雾测试
  - [x] 证据命令目录与报告命令一致
  - [x] 外部评审摘要补齐运行成本与分批理由
  - [x] 全量自查通过

## Entry R-042-Guardrail-CLI-Integration
- Timestamp: 2026-02-14 08:18:00 +08:00
- Stage: 下一轮推进（Stage-2 core-stability 门禁 CLI 集成覆盖）
- Actions:
  - 新增 `tests/test_stage2_guardrail_cli_smoke.py`：
    - 覆盖 `run_stage2_guardrail.py --core-stability` 的端到端 CLI 行为；
    - 覆盖完整性通过路径（exit=0）与不完整阻断路径（exit=2）。
  - 优化 `scripts/run_stage2_guardrail.py` 报告生成格式细节（`## Checks` 段落对齐）。
  - 升级 `docs/REVIEW_CHECKLIST.md` 至 `v2.3`：
    - Stage-2 新增硬性项：若引用 core-stability 证据，必须传 `--core-stability` 且 `core_stability.incomplete_count=0`。
  - 文档同步：
    - `docs/FINAL_REPORT.md` 追加 R-042 Delta；
    - `docs/design/next_phase_plan.md` 追加 R-042 Plan Update；
    - 新增评审摘要 `docs/review/r042_stage2_guardrail_cli_integration_summary.md`。
- Verification:
  - `python -m unittest tests.test_stage2_guardrail tests.test_stage2_guardrail_cli_smoke tests.test_core_claim_stability_resume_smoke -v` PASS (`9/9`)
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`100/100`)
  - `python -m compileall -q src scripts tests` PASS
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS (`passed=true`, `violation_count=0`)
  - `python scripts/run_stage2_guardrail.py --output outputs/stage2_guardrail.json --report docs/eval/stage2_guardrail_report.md --core-stability outputs/core_claim_stability_semi_real_5000_realistic.json --core-stability outputs/core_claim_stability_semi_real_5000_stress.json` PASS (`check_count=14`, `blocker_failures=0`)
  - `python scripts/build_patent_evidence_pack.py --output outputs/patent_evidence_pack.json --report "docs/patent_kit/10_区别特征_技术效果_实验映射.md"` PASS (`validation.passed=true`)
- Review Checklist:
  - [x] Stage-2 core-stability 门禁具备 CLI 集成测试覆盖
  - [x] 阻断路径（incomplete profile）具备可复现断言
  - [x] 清单规范已绑定 core-stability 完整性条件
  - [x] 证据包与报告重新构建并通过
  - [x] 全量自查通过

## Entry R-043-CI-Bundle-CoreStability-Integration
- Timestamp: 2026-02-14 15:34:00 +08:00
- Stage: 下一轮推进（将 core-stability 门禁实装进 CI 轻量流水）
- Actions:
  - 升级 `scripts/run_ci_guardrail_bundle.py`：
    - 新增 core-stability fixture 生成器；
    - CI bundle 自动生成：
      - `outputs/ci_outputs/core_claim_stability_ci_realistic.json`
      - `outputs/ci_outputs/core_claim_stability_ci_stress.json`
    - `run_stage2_guardrail.py` 调用链新增两个 `--core-stability` 参数（CI 默认执行，不依赖手工传参）。
  - 升级 `scripts/check_ci_output_isolation.py`：
    - 新增 `--core-stability` 到受控输出参数集合；
    - 新增 core-stability root JSON 路径违规检查；
    - 默认 bundle 命令构造同步新增 core-stability fixture 路径。
  - 升级 workflow artifact：
    - `.github/workflows/stage2-quality-gate.yml` 上传 core-stability fixture JSON；
    - `.github/workflows/stage2-nightly-trend.yml` 上传 core-stability fixture JSON。
  - 测试同步：
    - `tests/test_ci_guardrail_bundle_unit.py` 新增 fixture 写入测试并更新命令路径断言；
    - `tests/test_ci_output_isolation_unit.py` 新增 core-stability root-path 违规检测测试。
- Verification:
  - `python -m unittest tests.test_ci_guardrail_bundle_unit tests.test_ci_output_isolation_unit -v` PASS (`9/9`)
  - `python scripts/run_ci_guardrail_bundle.py --dataset-size 240 --benchmark-fragment-count 120 --runs 1 --warmup-runs 0` PASS（guardrail `check_count=14`, `blocker_failures=0`）
  - `python scripts/check_ci_output_isolation.py --output outputs/ci_outputs/output_isolation_check.json` PASS (`passed=true`, `violation_count=0`)
  - `python -m unittest discover -s tests -p "test_*.py"` PASS (`102/102`)
  - `python -m compileall -q src scripts tests` PASS
- Review Checklist:
  - [x] core-stability 门禁已进入 CI bundle 默认执行链路
  - [x] CI 路径隔离策略覆盖 `--core-stability` 参数
  - [x] workflow artifact 可追踪 core-stability fixture 输入
  - [x] 相关单测覆盖已补齐
  - [x] 全量自查通过
